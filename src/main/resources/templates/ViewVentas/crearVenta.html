<!DOCTYPE html>
<html lang="es"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6"
      layout:decorate="~{layouts/adminlte}">
<head>
    <title>Registrar Venta</title>
    <style>
        .cliente-card {
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 15px;
            background-color: #f9f9f9;
            transition: all 0.3s;
        }
        .cliente-card.encontrado {
            border: 2px solid #28a745;
            background-color: #d4edda;
        }
        .cliente-info {
            display: none;
        }
        .cliente-info.show {
            display: block;
        }

        /* --- NUEVOS AJUSTES PARA LIBERAR NAVEGACIÓN Y TECLADO --- */
        body.modal-open .content {
            filter: none !important;
        }

        .modal-backdrop {
            background-color: rgba(0,0,0,0.1) !important;
        }

        #modalAbrirCaja {
            z-index: 1070 !important;
        }

        #modalAbrirCaja .modal-content {
            border: 3px solid #007bff;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>

<div layout:fragment="content">
    <section class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1><i class="fas fa-cart-plus mr-2"></i> Nueva Venta</h1>
                </div>
            </div>
        </div>
    </section>

    <section class="content">
        <div class="container-fluid">
            <form th:action="@{/ventas/crear/nueva}" th:object="${venta}" method="POST" id="formVenta">
                <div class="row">
                    <div class="col-md-8">
                        <div class="card card-outline card-primary shadow">
                            <div class="card-header">
                                <h3 class="card-title font-weight-bold">
                                    <i class="fas fa-user-search mr-1"></i> Buscar Cliente
                                </h3>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="buscarNumeroId">
                                                <i class="fas fa-id-card mr-1"></i> Número de Identificación
                                                <span class="text-danger">*</span>
                                            </label>
                                            <div class="input-group">
                                                <input type="text" id="buscarNumeroId" class="form-control form-control-lg" placeholder="Ingrese cédula o NIT..." autocomplete="off">
                                                <div class="input-group-append">
                                                    <button type="button" class="btn btn-primary btn-lg" onclick="buscarCliente()"><i class="fas fa-search"></i></button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="d-block">&nbsp;</label>
                                        <div class="cliente-card" id="clienteCard">
                                            <div class="text-center text-muted" id="clienteNoSeleccionado">
                                                <i class="fas fa-user-slash fa-2x mb-2"></i>
                                                <p class="mb-0">Sin cliente seleccionado</p>
                                            </div>
                                            <div class="cliente-info" id="clienteInfo">
                                                <h5 class="text-success mb-2"><i class="fas fa-check-circle mr-1"></i> Cliente Encontrado</h5>
                                                <p class="mb-1"><strong>Nombre:</strong> <span id="clienteNombre"></span></p>
                                                <p class="mb-1"><strong>Email:</strong> <span id="clienteEmail"></span></p>
                                                <p class="mb-0"><strong>Teléfono:</strong> <span id="clienteTelefono"></span></p>
                                            </div>
                                        </div>
                                        <input type="hidden" th:field="*{cliente.id}" id="clienteIdHidden">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card card-outline card-info shadow">
                            <div class="card-header bg-light d-flex align-items-center">
                                <div class="flex-grow-1">
                                    <select id="filtroCategoria" class="form-control" style="width: 250px;" onchange="filtrarProductos()">
                                        <option value="ALL">-- Todas las Categorías --</option>
                                        <option th:each="cat : ${categorias}" th:value="${cat.id}" th:text="${cat.nombrecategoria}"></option>
                                    </select>
                                </div>
                                <button type="button" class="btn btn-primary btn-sm" onclick="agregarDetalle()">
                                    <i class="fas fa-plus mr-1"></i> Agregar Fila
                                </button>
                            </div>
                            <div class="card-body p-0">
                                <table class="table table-striped mb-0" id="tablaDetalles">
                                    <thead class="bg-info text-white">
                                    <tr>
                                        <th style="width: 40%">Producto</th>
                                        <th style="width: 15%">Cant.</th>
                                        <th style="width: 15%">Precio</th>
                                        <th style="width: 10%">Imp (%)</th>
                                        <th style="width: 20%">Subtotal</th>
                                        <th style="width: 40px"></th>
                                    </tr>
                                    </thead>
                                    <tbody id="detallesContainer">
                                    <tr class="detalle-item">
                                        <td>
                                            <select name="detalles[0].producto.id" class="form-control producto-select" onchange="actualizarPrecio(0)" required>
                                                <option value="" disabled selected>-- Seleccione --</option>
                                                <option th:each="p : ${productos}"
                                                        th:value="${p.id}"
                                                        th:text="${p.nombre}"
                                                        th:data-precio="${p.precio}"
                                                        th:data-tipo="${p.tipoVenta.name()}"
                                                        th:data-categoria="${p.categoria.id}"
                                                        th:data-impuesto="${p.impuesto}"></option>
                                            </select>
                                        </td>
                                        <td><input type="number" name="detalles[0].cantidad" class="form-control" value="1" min="0.001" step="0.001" onchange="calcularSubtotal(0)" required></td>
                                        <td><input type="number" name="detalles[0].precioUnitario" class="form-control precio-unitario" readonly></td>
                                        <td><input type="text" class="form-control impuesto-porcentaje" readonly value="0"></td>
                                        <td><input type="number" name="detalles[0].subtotal" class="form-control subtotal-item" readonly></td>
                                        <td class="text-center"><button type="button" class="btn btn-link text-danger" onclick="eliminarFila(this)"><i class="fas fa-times-circle"></i></button></td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="card card-primary card-outline shadow">
                            <div class="card-header">
                                <h3 class="card-title font-weight-bold">Datos de Facturación</h3>
                            </div>
                            <div class="card-body">
                                <div class="form-group">
                                    <label>Método de Pago <span class="text-danger">*</span></label>
                                    <select class="form-control" th:field="*{metodoPago}" id="metodoPagoSelect" required>
                                        <option value="" disabled selected>Seleccione pago...</option>
                                        <option value="EFECTIVO">Efectivo</option>
                                        <option value="TRANSFERENCIA">Transferencia</option>
                                        <option value="TARJETA">Tarjeta</option>
                                        <option value="MIXTO">Mixto</option>
                                    </select>
                                </div>
                                <hr>
                                <div class="bg-light p-3 rounded">
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Subtotal:</span>
                                        <input type="number" id="subtotalGeneral" class="form-control form-control-sm text-right border-0 bg-transparent font-weight-bold" readonly value="0.000">
                                    </div>
                                    <div class="form-group mb-2">
                                        <label class="small">Impuesto Total ($)</label>
                                        <input type="number" id="impuesto" th:field="*{impuesto}" class="form-control form-control-sm text-right bg-transparent border-0 font-weight-bold" readonly value="0">
                                    </div>
                                    <div class="d-flex justify-content-between text-lg text-primary font-weight-bold mt-3">
                                        <span>TOTAL:</span>
                                        <div>$ <input type="number" id="totalVenta" th:field="*{total}" class="d-inline text-right border-0 bg-transparent font-weight-bold text-primary" readonly style="width: 120px;"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-footer">
                                <button type="button" onclick="validarYProcesar()" class="btn btn-success btn-block shadow">
                                    <i class="fas fa-save mr-1"></i> Finalizar Venta
                                </button>
                                <a href="/ventas/listar" class="btn btn-default btn-block mt-2">Cancelar</a>

                                <div th:if="${cajaAbierta != null}" class="mt-4">
                                    <button class="btn btn-danger btn-block shadow" data-toggle="modal" data-target="#modalCerrarCaja">
                                        <i class="fas fa-lock mr-1"></i> Cerrar Caja
                                    </button>
                                    <a th:href="@{/caja/cerrar/ticket/{id}(id=${cajaAbierta.id})}" target="_blank" class="btn btn-secondary btn-block mt-2 shadow">
                                        <i class="fas fa-print mr-1"></i> Imprimir Resumen de Caja
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </section>

    <div th:if="${necesitaAbrirCaja}" class="modal fade" id="modalAbrirCaja" role="dialog">...</div>
    <div class="modal fade" id="modalCerrarCaja" tabindex="-1" th:if="${cajaAbierta != null}">...</div>
</div>

<th:block layout:fragment="scripts">
    <script th:inline="javascript">
        const clientesData = /*[[${clientes}]]*/ [];
        let detalleCount = 1;

        $(document).ready(function () {
            const s = /*[[${success}]]*/ null;
            const e = /*[[${error}]]*/ null;
            const i = /*[[${info}]]*/ null;
            const w = /*[[${warning}]]*/ null;
            checkNotifications(s, e, i, w);

            const necesitaAbrir = /*[[${necesitaAbrirCaja}]]*/ false;
            if (necesitaAbrir) {
                $('#modalAbrirCaja').modal({ backdrop: 'static', keyboard: true, show: true });
                setTimeout(() => $('#montoInicialInput').focus(), 800);
            }
        });

        // --- FUNCIÓN DE FILTRADO CORREGIDA ---
        function filtrarProductos() {
            const catId = document.getElementById('filtroCategoria').value;
            document.querySelectorAll('.producto-select').forEach(select => {
                const options = select.querySelectorAll('option');
                options.forEach(opt => {
                    if (opt.value === "" || catId === "ALL") {
                        opt.style.display = "block";
                    } else {
                        const optCat = opt.getAttribute('data-categoria');
                        opt.style.display = (optCat === catId) ? "block" : "none";
                    }
                });
                select.value = ""; // Reiniciar selección para evitar inconsistencias
            });
        }

        async function validarYProcesar() {
            const necesitaAbrir = /*[[${necesitaAbrirCaja}]]*/ false;
            if (necesitaAbrir) {
                Swal.fire({ icon: 'error', title: 'Caja cerrada', text: 'Debe abrir la caja primero.' });
                $('#modalAbrirCaja').modal('show');
                return;
            }
            const clienteId = document.getElementById('clienteIdHidden').value;
            if (!clienteId) {
                Swal.fire({ icon: 'warning', title: 'Cliente requerido', text: 'Debe seleccionar un cliente' });
                return;
            }
            document.getElementById('formVenta').submit();
        }

        function buscarCliente() {
            const numeroId = document.getElementById('buscarNumeroId').value.trim();
            if (!numeroId) { Swal.fire('Atención', 'Ingrese un ID', 'warning'); return; }
            const clienteEncontrado = clientesData.find(c => c.numeroIdentificacion === numeroId);
            if (clienteEncontrado) { mostrarClienteEncontrado(clienteEncontrado); }
            else { Swal.fire({ title: 'No encontrado', text: '¿Registrar?', icon: 'question', showCancelButton: true }).then((r) => { if (r.isConfirmed) window.open('/crearcliente/nuevo', '_blank'); }); }
        }

        function mostrarClienteEncontrado(c) {
            document.getElementById('clienteIdHidden').value = c.id;
            document.getElementById('clienteNombre').textContent = c.nombre + ' ' + (c.apellido || '');
            document.getElementById('clienteEmail').textContent = c.email || 'N/A';
            document.getElementById('clienteTelefono').textContent = c.telefono || 'N/A';
            document.getElementById('clienteNoSeleccionado').style.display = 'none';
            document.getElementById('clienteInfo').classList.add('show');
            document.getElementById('clienteCard').classList.add('encontrado');
        }

        function agregarDetalle() {
            const container = document.getElementById('detallesContainer');
            const opciones = document.querySelector('.producto-select').innerHTML;
            const tr = document.createElement('tr');
            tr.className = "detalle-item";
            tr.innerHTML = `
                <td><select name="detalles[${detalleCount}].producto.id" class="form-control producto-select" onchange="actualizarPrecio(${detalleCount})" required>${opciones}</select></td>
                <td><input type="number" name="detalles[${detalleCount}].cantidad" class="form-control" value="1" min="0.001" step="0.001" onchange="calcularSubtotal(${detalleCount})" required></td>
                <td><input type="number" name="detalles[${detalleCount}].precioUnitario" class="form-control precio-unitario" readonly step="0.001"></td>
                <td><input type="text" class="form-control impuesto-porcentaje" readonly value="0"></td>
                <td><input type="number" name="detalles[${detalleCount}].subtotal" class="form-control subtotal-item" readonly step="0.001"></td>
                <td class="text-center"><button type="button" class="btn btn-link text-danger p-0" onclick="eliminarFila(this)"><i class="fas fa-times-circle"></i></button></td>`;
            container.appendChild(tr);
            detalleCount++;
            filtrarProductos(); // Aplicar filtro a la nueva fila
        }

        function eliminarFila(btn) {
            const filas = document.querySelectorAll('.detalle-item');
            if(filas.length > 1) {
                btn.closest('tr').remove();
                calcularTotal();
            } else {
                Swal.fire('Atención', 'La venta debe tener al menos un producto', 'info');
            }
        }

        function actualizarPrecio(i) {
            const select = document.getElementsByName(`detalles[${i}].producto.id`)[0];
            const option = select.options[select.selectedIndex];
            const precio = option.getAttribute("data-precio");
            const impuesto = option.getAttribute("data-impuesto") || 0;

            const fila = select.closest('tr');
            fila.querySelector('.precio-unitario').value = parseFloat(precio).toFixed(3);
            fila.querySelector('.impuesto-porcentaje').value = impuesto;

            calcularSubtotal(i);
        }

        function calcularSubtotal(i) {
            const fila = document.querySelectorAll('.detalle-item')[i];
            const select = fila.querySelector('.producto-select');
            const tipoVenta = select.options[select.selectedIndex].getAttribute("data-tipo");
            let cant = parseFloat(fila.querySelector('input[name*=".cantidad"]').value) || 0;
            const precio = parseFloat(fila.querySelector('.precio-unitario').value) || 0;

            if (tipoVenta === 'PESO') cant = cant / 1000;
            fila.querySelector('.subtotal-item').value = (cant * precio).toFixed(3);
            calcularTotal();
        }

        // --- CÁLCULO DE TOTAL E IMPUESTO CORREGIDO ---
        function calcularTotal() {
            let subtotalGlobal = 0;
            let impuestoGlobal = 0;

            document.querySelectorAll('.detalle-item').forEach(fila => {
                const subtotalFila = parseFloat(fila.querySelector('.subtotal-item').value) || 0;
                const porcImpuesto = parseFloat(fila.querySelector('.impuesto-porcentaje').value) || 0;

                subtotalGlobal += subtotalFila;
                impuestoGlobal += (subtotalFila * (porcImpuesto / 100));
            });

            document.getElementById('subtotalGeneral').value = subtotalGlobal.toFixed(3);
            document.getElementById('impuesto').value = impuestoGlobal.toFixed(3); // Suma de impuestos monetarios
            document.getElementById('totalVenta').value = (subtotalGlobal + impuestoGlobal).toFixed(3);
        }

        // Funciones de caja omitidas por brevedad (calcularDiferencia, cerrarCajaConTicket) se mantienen igual.
    </script>
</th:block>
</body>
</html>