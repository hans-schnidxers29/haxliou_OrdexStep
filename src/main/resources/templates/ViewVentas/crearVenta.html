<!DOCTYPE html>
<html lang="es"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6"
      layout:decorate="~{layouts/adminlte}">
<head>
    <title>Registrar Venta</title>
</head>
<body>

<div layout:fragment="content">
    <section class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1><i class="fas fa-cart-plus mr-2"></i> Nueva Venta</h1>
                </div>
            </div>
        </div>
    </section>

    <section class="content">
        <div class="container-fluid">
            <form th:action="@{/ventas/crear/nueva}" th:object="${venta}" method="POST">

                <div class="row">
                    <div class="col-md-4">
                        <div class="card card-primary card-outline shadow">
                            <div class="card-header">
                                <h3 class="card-title font-weight-bold">Datos de Facturación</h3>
                            </div>
                            <div class="card-body">
                                <div class="form-group">
                                    <label>Cliente <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        <select class="form-control select2" th:field="*{cliente}" required>
                                            <option value="" disabled selected>Seleccione un cliente</option>
                                            <option th:each="c : ${clientes}" th:value="${c.id}" th:text="${c.nombre}"></option>
                                        </select>
                                        <div class="input-group-append">
                                            <a href="/crearcliente/nuevo" class="btn btn-outline-primary" title="Nuevo Cliente">
                                                <i class="fas fa-plus"></i>
                                            </a>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label>Método de Pago <span class="text-danger">*</span></label>
                                    <select class="form-control" th:field="*{metodoPago}" required>
                                        <option value="" disabled selected>Seleccione pago...</option>
                                        <option value="EFECTIVO">Efectivo</option>
                                        <option value="TRANSFERENCIA">Transferencia</option>
                                        <option value="TARJETA">Tarjeta</option>
                                        <option value="MIXTO">Mixto</option>
                                    </select>
                                </div>

                                <hr>

                                <div class="bg-light p-3 rounded">
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Subtotal:</span>
                                        <input type="number" id="subtotalGeneral" class="form-control form-control-sm text-right border-0 bg-transparent font-weight-bold" readonly value="0.000">
                                    </div>
                                    <div class="form-group mb-2">
                                        <label class="small">Impuesto (%)</label>
                                        <input type="number" id="impuesto" th:field="*{impuesto}" class="form-control form-control-sm text-right" onchange="calcularTotal()" value="0">
                                    </div>
                                    <div class="d-flex justify-content-between text-lg text-primary font-weight-bold mt-3">
                                        <span>TOTAL:</span>
                                        <div>
                                            $ <input type="number" id="totalVenta" th:field="*{total}" class="d-inline text-right border-0 bg-transparent font-weight-bold text-primary" readonly style="width: 120px;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-footer">
                                <button type="submit" class="btn btn-success btn-block shadow">
                                    <i class="fas fa-save mr-1"></i> Finalizar Venta
                                </button>
                                <a href="/ventas/listar" class="btn btn-default btn-block mt-2">Cancelar</a>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-8">
                        <div class="card card-outline card-info shadow">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h3 class="card-title font-weight-bold">Detalle de Productos</h3>
                                <button type="button" class="btn btn-primary btn-sm ml-auto" onclick="agregarDetalle()">
                                    <i class="fas fa-plus mr-1"></i> Agregar Fila
                                </button>
                            </div>
                            <div class="card-body p-0">
                                <table class="table table-striped mb-0" id="tablaDetalles">
                                    <thead class="bg-info text-white">
                                    <tr>
                                        <th style="width: 45%">Producto</th>
                                        <th style="width: 15%">Cantidad</th>
                                        <th style="width: 20%">Precio Unit.</th>
                                        <th style="width: 20%">Subtotal</th>
                                        <th style="width: 40px"></th>
                                    </tr>
                                    </thead>
                                    <tbody id="detallesContainer">
                                    <tr class="detalle-item">
                                        <td>
                                            <select name="detalles[0].producto.id" class="form-control producto-select" onchange="actualizarPrecio(0)" required>
                                                <option value="" disabled selected>-- Seleccione --</option>
                                                <option th:each="p : ${productos}"
                                                        th:value="${p.id}"
                                                        th:text="${p.nombre}"
                                                        th:data-precio="${p.precio}"></option>
                                            </select>
                                        </td>
                                        <td>
                                            <input type="number" name="detalles[0].cantidad" class="form-control" value="1" min="1" onchange="calcularSubtotal(0)" required>
                                        </td>
                                        <td>
                                            <input type="number" name="detalles[0].precioUnitario" class="form-control precio-unitario" readonly step="0.001" value="0.000">
                                        </td>
                                        <td>
                                            <input type="number" name="detalles[0].subtotal" class="form-control subtotal-item" readonly step="0.001" value="0.000">
                                        </td>
                                        <td class="text-center">
                                            <button type="button" class="btn btn-link text-danger p-0" onclick="eliminarFila(this)"><i class="fas fa-times-circle"></i></button>
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </section>
</div>

<th:block layout:fragment="scripts">
    <script>
        let detalleCount = 1;

        function agregarDetalle() {
            const container = document.getElementById('detallesContainer');
            // Clonamos el contenido del primer select para mantener los data-precio
            const opciones = document.querySelector('.producto-select').innerHTML;

            const tr = document.createElement('tr');
            tr.className = "detalle-item";
            tr.innerHTML = `
                <td>
                    <select name="detalles[${detalleCount}].producto.id" class="form-control producto-select" onchange="actualizarPrecio(${detalleCount})" required>
                        ${opciones}
                    </select>
                </td>
                <td>
                    <input type="number" name="detalles[${detalleCount}].cantidad" class="form-control" value="1" min="1" onchange="calcularSubtotal(${detalleCount})" required>
                </td>
                <td>
                    <input type="number" name="detalles[${detalleCount}].precioUnitario" class="form-control precio-unitario" readonly step="0.001">
                </td>
                <td>
                    <input type="number" name="detalles[${detalleCount}].subtotal" class="form-control subtotal-item" readonly step="0.001">
                </td>
                <td class="text-center">
                    <button type="button" class="btn btn-link text-danger p-0" onclick="eliminarFila(this)"><i class="fas fa-times-circle"></i></button>
                </td>
            `;
            container.appendChild(tr);
            detalleCount++;
        }

        function eliminarFila(btn) {
            const filas = document.querySelectorAll('.detalle-item');
            if(filas.length > 1) {
                btn.closest('tr').remove();
                calcularTotal();
            } else {
                Swal.fire('Atención', 'La venta debe tener al menos un producto', 'info');
            }
        }

        function actualizarPrecio(i) {
            const select = document.querySelector(`select[name="detalles[${i}].producto.id"]`);
            const precio = select.options[select.selectedIndex].getAttribute("data-precio");
            document.querySelector(`input[name="detalles[${i}].precioUnitario"]`).value = parseFloat(precio).toFixed(3) || 0;
            calcularSubtotal(i);
        }

        function calcularSubtotal(i) {
            const cant = parseFloat(document.querySelector(`input[name="detalles[${i}].cantidad"]`).value) || 0;
            const precio = parseFloat(document.querySelector(`input[name="detalles[${i}].precioUnitario"]`).value) || 0;
            const subtotal = cant * precio;
            document.querySelector(`input[name="detalles[${i}].subtotal"]`).value = subtotal.toFixed(3);
            calcularTotal();
        }

        function calcularTotal() {
            let subtotalGral = 0;
            document.querySelectorAll('.subtotal-item').forEach(input => {
                subtotalGral += parseFloat(input.value) || 0;
            });

            const impuestoPorcentaje = parseFloat(document.getElementById('impuesto').value) || 0;
            const totalFinal = subtotalGral + (subtotalGral * (impuestoPorcentaje / 100));

            document.getElementById('subtotalGeneral').value = subtotalGral.toFixed(3);
            document.getElementById('totalVenta').value = totalFinal.toFixed(3);
        }
    </script>
</th:block>

</body>
</html>