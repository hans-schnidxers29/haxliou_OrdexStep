<!DOCTYPE html>
<html lang="es"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6"
      layout:decorate="~{layouts/adminlte}">
<head>
    <title>Registrar Venta</title>
    <style>
        .cliente-card {
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 15px;
            background-color: #f9f9f9;
            transition: all 0.3s;
        }
        .cliente-card.encontrado {
            border: 2px solid #28a745;
            background-color: #d4edda;
        }
        .cliente-info {
            display: none;
        }
        .cliente-info.show {
            display: block;
        }

        /* Ajustes para modal */
        body.modal-open .content {
            filter: none !important;
        }
        .modal-backdrop {
            background-color: rgba(0,0,0,0.1) !important;
        }
        #modalAbrirCaja {
            z-index: 1070 !important;
        }
        #modalAbrirCaja .modal-content {
            border: 3px solid #007bff;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>

<div layout:fragment="content">
    <!-- HEADER CON BOTONES DE CAJA -->
    <section class="content-header">
        <div class="container-fluid">
            <div class="row mb-2 align-items-center">
                <div class="col-sm-6">
                    <h1><i class="fas fa-cart-plus mr-2"></i> Nueva Venta</h1>
                </div>
                <div class="col-sm-6 text-right">
                    <!-- BOTONES DE CAJA (SIEMPRE VISIBLES SI HAY CAJA ABIERTA) -->
                    <div th:if="${cajaAbierta != null}">
                        <button type="button" class="btn btn-danger shadow mr-2" data-toggle="modal" data-target="#modalCerrarCaja">
                            <i class="fas fa-lock mr-1"></i> Cerrar Caja
                        </button>
                        <a th:href="@{/caja/cerrar/ticket/{id}(id=${cajaAbierta.id})}" target="_blank" class="btn btn-secondary shadow">
                            <i class="fas fa-print mr-1"></i> Imprimir Resumen
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section class="content">
        <div class="container-fluid">
            <form th:action="@{/ventas/crear/nueva}" th:object="${venta}" method="POST" id="formVenta">
                <div class="row">
                    <div class="col-md-8">
                        <!-- BUSCAR CLIENTE -->
                        <div class="card card-outline card-primary shadow">
                            <div class="card-header">
                                <h3 class="card-title font-weight-bold">
                                    <i class="fas fa-user-search mr-1"></i> Buscar Cliente
                                </h3>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="buscarNumeroId">
                                                <i class="fas fa-id-card mr-1"></i> Número de Identificación
                                                <span class="text-danger">*</span>
                                            </label>
                                            <div class="input-group">
                                                <input type="text" id="buscarNumeroId" class="form-control form-control-lg" placeholder="Ingrese cédula o NIT..." autocomplete="off">
                                                <div class="input-group-append">
                                                    <button type="button" class="btn btn-primary btn-lg" onclick="buscarCliente()">
                                                        <i class="fas fa-search"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="d-block">&nbsp;</label>
                                        <div class="cliente-card" id="clienteCard">
                                            <div class="text-center text-muted" id="clienteNoSeleccionado">
                                                <i class="fas fa-user-slash fa-2x mb-2"></i>
                                                <p class="mb-0">Sin cliente seleccionado</p>
                                            </div>
                                            <div class="cliente-info" id="clienteInfo">
                                                <h5 class="text-success mb-2">
                                                    <i class="fas fa-check-circle mr-1"></i> Cliente Encontrado
                                                </h5>
                                                <p class="mb-1"><strong>Nombre:</strong> <span id="clienteNombre"></span></p>
                                                <p class="mb-1"><strong>Email:</strong> <span id="clienteEmail"></span></p>
                                                <p class="mb-0"><strong>Teléfono:</strong> <span id="clienteTelefono"></span></p>
                                            </div>
                                        </div>
                                        <input type="hidden" th:field="*{cliente.id}" id="clienteIdHidden">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- DETALLE DE PRODUCTOS -->
                        <div class="card card-info shadow">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h3 class="card-title font-weight-bold">
                                    <i class="fas fa-boxes mr-1"></i> Ítems del Pedido
                                </h3>
                                <button type="button" class="btn btn-primary btn-sm ml-auto" onclick="agregarDetalle()">
                                    <i class="fas fa-plus mr-1"></i> Agregar Producto
                                </button>
                            </div>
                            <div class="card-body p-0">
                                <table class="table table-striped mb-0">
                                    <thead class="bg-light">
                                    <tr>
                                        <th style="width: 25%">Categoría</th>
                                        <th style="width: 25%">Producto</th>
                                        <th style="width: 10%">Cant.</th>
                                        <th style="width: 15%">P. Unit</th>
                                        <th style="width: 10%">IVA %</th>
                                        <th style="width: 15%">Subtotal</th>
                                        <th style="width: 40px"></th>
                                    </tr>
                                    </thead>
                                    <tbody id="detallesContainer">
                                    <tr class="detalle-item">
                                        <td>
                                            <select class="form-control categoria-filter" onchange="filtrarProductos(this)">
                                                <option value="">-- Todas --</option>
                                                <option th:each="cat : ${categorias}"
                                                        th:value="${cat.id}"
                                                        th:text="${cat.nombrecategoria}"></option>
                                            </select>
                                        </td>
                                        <td>
                                            <select name="detalles[0].producto.id" class="form-control producto-select" required onchange="actualizarPrecio(0)">
                                                <option value="" disabled selected>-- Seleccionar --</option>
                                                <option th:each="p : ${productos}"
                                                        th:value="${p.id}"
                                                        th:text="${p.nombre}"
                                                        th:data-categoria="${p.categoria.id}"
                                                        th:data-precio="${p.precio}"
                                                        th:data-impuesto="${p.impuesto}"
                                                        th:data-tipo="${p.tipoVenta.name()}"></option>
                                            </select>
                                        </td>
                                        <td>
                                            <input type="number" name="detalles[0].cantidad" class="form-control cantidad-input" min="0.01" value="1.00" step="0.01" required onchange="calcularSubtotal(0)">
                                        </td>
                                        <td>
                                            <input type="number" name="detalles[0].precioUnitario" class="form-control precio-unitario bg-light" step="0.01" readonly>
                                        </td>
                                        <td>
                                            <input type="number" name="detalles[0].impuestoProducto" class="form-control impuesto-producto bg-light" step="0.01" readonly>
                                        </td>
                                        <td>
                                            <input type="number" name="detalles[0].subtotal" class="form-control subtotal-item bg-light text-bold" step="0.01" readonly>
                                        </td>
                                        <td class="text-center"></td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- PANEL DE FACTURACIÓN -->
                    <div class="col-md-4">
                        <div class="card card-primary card-outline shadow">
                            <div class="card-header">
                                <h3 class="card-title font-weight-bold">Datos de Facturación</h3>
                            </div>
                            <div class="card-body">
                                <div class="form-group">
                                    <label>Método de Pago <span class="text-danger">*</span></label>
                                    <select class="form-control" th:field="*{metodoPago}" id="metodoPagoSelect" required>
                                        <option value="" disabled selected>Seleccione pago...</option>
                                        <option value="EFECTIVO">Efectivo</option>
                                        <option value="TRANSFERENCIA">Transferencia</option>
                                        <option value="TARJETA">Tarjeta</option>
                                        <option value="MIXTO">Mixto</option>
                                    </select>
                                </div>
                                <hr>
                                <div class="bg-light p-3 rounded">
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Subtotal:</span>
                                        <input type="number" id="subtotalGeneral" class="form-control form-control-sm text-right border-0 bg-transparent font-weight-bold" readonly value="0.00">
                                    </div>
                                    <div class="form-group mb-2">
                                        <label class="small">Impuesto Total ($)</label>
                                        <input type="number" id="impuesto" th:field="*{impuesto}" class="form-control form-control-sm text-right bg-transparent border-0 font-weight-bold" readonly value="0">
                                    </div>
                                    <div class="d-flex justify-content-between text-lg text-primary font-weight-bold mt-3">
                                        <span>TOTAL:</span>
                                        <div>
                                            $ <input type="number" id="totalVenta" th:field="*{total}" class="d-inline text-right border-0 bg-transparent font-weight-bold text-primary" readonly style="width: 120px;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-footer">
                                <button type="button" onclick="validarYProcesar()" class="btn btn-success btn-block shadow">
                                    <i class="fas fa-save mr-1"></i> Finalizar Venta
                                </button>
                                <a href="/ventas/listar" class="btn btn-default btn-block mt-2">Cancelar</a>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </section>

    <!-- MODAL ABRIR CAJA -->
    <div th:if="${necesitaAbrirCaja}" class="modal fade" id="modalAbrirCaja" data-backdrop="static" data-keyboard="false" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content border-primary shadow-lg">
                <div class="modal-header bg-primary text-white text-center d-block">
                    <h5 class="modal-title"><i class="fas fa-cash-register mr-2"></i> Apertura de Caja Requerida</h5>
                </div>
                <form th:action="@{/caja/abrir}" method="POST">
                    <div class="modal-body text-center">
                        <p class="mb-4">Para poder facturar, debe ingresar el <strong>monto base (saldo inicial)</strong> que hay en caja actualmente.</p>
                        <div class="form-group">
                            <label for="montoInicialInput">Efectivo Inicial en Caja:</label>
                            <div class="input-group input-group-lg">
                                <div class="input-group-prepend">
                                    <span class="input-group-text font-weight-bold">$</span>
                                </div>
                                <input type="number" name="montoInicial" id="montoInicialInput" class="form-control text-center font-weight-bold" placeholder="0.00" step="0.01" min="0" required autofocus>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer bg-light">
                        <button type="submit" class="btn btn-primary btn-block btn-lg font-weight-bold">
                            <i class="fas fa-key mr-2"></i> ABRIR CAJA Y CONTINUAR
                        </button>
                        <a href="/" class="btn btn-link btn-sm text-muted">Volver al Menú Principal</a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- MODAL CERRAR CAJA -->
    <!-- MODAL CERRAR CAJA -->
    <div class="modal fade" id="modalCerrarCaja" tabindex="-1" th:if="${cajaAbierta != null}">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-lock mr-2"></i> Cerrar Caja del Día
                    </h5>
                    <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
                </div>
                <form th:action="@{/caja/cerrar/{id}(id=${cajaAbierta.id})}" method="POST" id="formCerrarCaja">
                    <div class="modal-body">
                        <!-- Información de la caja -->
                        <div class="alert alert-info">
                            <h6 class="font-weight-bold mb-2">
                                <i class="fas fa-info-circle mr-1"></i> Información de Caja
                            </h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <p class="mb-1"><strong>Apertura:</strong> <span th:text="${#temporals.format(cajaAbierta.fechaApertura, 'dd/MM/yyyy HH:mm')}"></span></p>
                                    <p class="mb-1"><strong>Monto Inicial:</strong> $<span th:text="${#numbers.formatDecimal(cajaAbierta.montoInicial, 1, 'COMMA', 2, 'POINT')}"></span></p>
                                </div>
                                <div class="col-md-6">
                                    <p class="mb-1"><strong>Ingresos:</strong> $<span th:text="${#numbers.formatDecimal(resumen.ingresosEfectivo, 1, 'COMMA', 2, 'POINT')}"></span></p>
                                    <p class="mb-1"><strong>Egresos:</strong> $<span th:text="${#numbers.formatDecimal(resumen.egresosTotales, 1, 'COMMA', 2, 'POINT')}"></span></p>
                                </div>
                            </div>
                        </div>

                        <!-- Monto esperado -->
                        <div class="card bg-light mb-3">
                            <div class="card-body py-2">
                                <div class="row align-items-center">
                                    <div class="col-md-6">
                                        <h5 class="mb-0 text-primary">
                                            <i class="fas fa-calculator mr-1"></i> Monto Esperado en Caja:
                                        </h5>
                                    </div>
                                    <div class="col-md-6 text-right">
                                        <h3 class="mb-0 font-weight-bold text-success" id="montoEsperado">
                                            $<span th:text="${#numbers.formatDecimal(resumen.saldoActual, 1, 'COMMA', 2, 'POINT')}"></span>
                                        </h3>
                                        <input type="hidden" id="montoEsperadoValue" th:value="${cajaAbierta.montoEsperado}">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Input para monto real -->
                        <div class="form-group">
                            <label for="montoRealInput" class="font-weight-bold">
                                <i class="fas fa-money-bill-wave mr-1"></i> Efectivo Real en Caja:
                                <span class="text-danger">*</span>
                            </label>
                            <div class="input-group input-group-lg">
                                <div class="input-group-prepend">
                                    <span class="input-group-text bg-success text-white font-weight-bold">$</span>
                                </div>
                                <input type="number"
                                       name="montoReal"
                                       id="montoRealInput"
                                       class="form-control form-control-lg text-center font-weight-bold"
                                       placeholder="0.00"
                                       step="0.01"
                                       min="0"
                                       required
                                       oninput="calcularDiferenciaCierre()">
                            </div>
                            <small class="text-muted">Cuente el dinero físico que hay en la caja actualmente</small>
                        </div>

                        <!-- Diferencia calculada -->
                        <div id="alertDiferencia" class="alert" style="display: none;">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="font-weight-bold">
                                    <i class="fas fa-exchange-alt mr-1"></i> Diferencia:
                                </span>
                                <h4 class="mb-0 font-weight-bold" id="textoDiferencia">$0.00</h4>
                            </div>
                            <small id="mensajeDiferencia"></small>
                        </div>

                        <!-- Observaciones -->
                        <div class="form-group">
                            <label for="observacionesInput" class="font-weight-bold">
                                <i class="fas fa-comment-dots mr-1"></i> Observaciones:
                            </label>
                            <textarea name="observaciones"
                                      id="observacionesInput"
                                      class="form-control"
                                      rows="3"
                                      placeholder="Agregue comentarios sobre diferencias, incidencias o notas del día..."></textarea>
                            <small class="text-muted">
                                <span id="requiereObservacion" style="display: none;" class="text-warning">
                                    <i class="fas fa-exclamation-triangle"></i> Se recomienda agregar observaciones cuando hay diferencia
                                </span>
                            </small>
                        </div>
                    </div>
                    <div class="modal-footer bg-light">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">
                            <i class="fas fa-times mr-1"></i> Cancelar
                        </button>
                        <button type="submit" class="btn btn-danger btn-lg" id="btnConfirmarCierre">
                            <i class="fas fa-lock mr-1" href="cierre"></i> Confirmar Cierre de Caja
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
</div>

<th:block layout:fragment="scripts">
    <script th:inline="javascript">
        const clientesData = /*[[${clientes}]]*/ [];
        let detalleCount = 1;

        $(document).ready(function () {
            const s = /*[[${success}]]*/ null;
            const e = /*[[${error}]]*/ null;
            const i = /*[[${info}]]*/ null;
            const w = /*[[${warning}]]*/ null;
            if (typeof checkNotifications === 'function') {
                checkNotifications(s, e, i, w);
            }

            const necesitaAbrir = /*[[${necesitaAbrirCaja}]]*/ false;
            if (necesitaAbrir) {
                $('#modalAbrirCaja').modal({ backdrop: 'static', keyboard: true, show: true });
                setTimeout(() => $('#montoInicialInput').focus(), 800);
            }
        });

        // Filtrar productos por categoría en la fila específica
        function filtrarProductos(selectElement) {
            const catId = selectElement.value;
            const fila = selectElement.closest('tr');
            const productoSelect = fila.querySelector('.producto-select');
            const options = productoSelect.querySelectorAll('option');

            options.forEach(opt => {
                if (opt.value === "" || catId === "" || opt.getAttribute('data-categoria') === catId) {
                    opt.style.display = "block";
                } else {
                    opt.style.display = "none";
                }
            });
            productoSelect.value = "";
            actualizarPrecioFila(productoSelect);
        }

        async function validarYProcesar() {
            const necesitaAbrir = /*[[${necesitaAbrirCaja}]]*/ false;
            if (necesitaAbrir) {
                Swal.fire({ icon: 'error', title: 'Caja cerrada', text: 'Debe abrir la caja primero.' });
                $('#modalAbrirCaja').modal('show');
                return;
            }
            const clienteId = document.getElementById('clienteIdHidden').value;
            if (!clienteId) {
                Swal.fire({ icon: 'warning', title: 'Cliente requerido', text: 'Debe seleccionar un cliente' });
                return;
            }
            document.getElementById('formVenta').submit();
        }

        function buscarCliente() {
            const numeroId = document.getElementById('buscarNumeroId').value.trim();
            if (!numeroId) {
                Swal.fire('Atención', 'Ingrese un número de identificación', 'warning');
                return;
            }
            const cliente = clientesData.find(c => c.numeroIdentificacion === numeroId);
            if (cliente) {
                document.getElementById('clienteIdHidden').value = cliente.id;
                document.getElementById('clienteNombre').textContent = cliente.nombre + ' ' + (cliente.apellido || '');
                document.getElementById('clienteEmail').textContent = cliente.email || 'N/A';
                document.getElementById('clienteTelefono').textContent = cliente.telefono || 'N/A';
                document.getElementById('clienteNoSeleccionado').style.display = 'none';
                document.getElementById('clienteInfo').classList.add('show');
                document.getElementById('clienteCard').classList.add('encontrado');
                Swal.fire({ icon: 'success', title: 'Cliente Encontrado', timer: 1000, showConfirmButton: false });
            } else {
                Swal.fire({
                    title: 'Cliente no encontrado',
                    text: '¿Desea registrarlo?',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'Sí, registrar'
                }).then((result) => {
                    if (result.isConfirmed) window.open('/crearcliente/nuevo', '_blank');
                });
            }
        }

        function agregarDetalle() {
            const container = document.getElementById('detallesContainer');
            const opcionesCat = document.querySelector('.categoria-filter').innerHTML;
            const opcionesProd = document.querySelector('.producto-select').innerHTML;

            const tr = document.createElement('tr');
            tr.className = 'detalle-item';
            tr.innerHTML = `
                <td>
                    <select class="form-control categoria-filter" onchange="filtrarProductos(this)">
                        ${opcionesCat}
                    </select>
                </td>
                <td>
                    <select name="detalles[${detalleCount}].producto.id" class="form-control producto-select" required onchange="actualizarPrecioFila(this)">
                        ${opcionesProd}
                    </select>
                </td>
                <td>
                    <input type="number" name="detalles[${detalleCount}].cantidad" class="form-control cantidad-input" min="0.01" value="1.00" step="0.01" required onchange="calcularSubtotalFila(this)">
                </td>
                <td>
                    <input type="number" name="detalles[${detalleCount}].precioUnitario" class="form-control precio-unitario bg-light" readonly step="0.01">
                </td>
                <td>
                    <input type="number" name="detalles[${detalleCount}].impuestoProducto" class="form-control impuesto-producto bg-light" readonly step="0.01">
                </td>
                <td>
                    <input type="number" name="detalles[${detalleCount}].subtotal" class="form-control subtotal-item bg-light text-bold" readonly step="0.01">
                </td>
                <td class="text-center">
                    <button type="button" class="btn btn-link text-danger" onclick="eliminarFila(this)"><i class="fas fa-trash-alt"></i></button>
                </td>
            `;
            container.appendChild(tr);
            detalleCount++;
        }

        function eliminarFila(btn) {
            btn.closest('tr').remove();
            calcularTotal();
        }

        // Función corregida para usar el elemento directamente
        function actualizarPrecioFila(select) {
            const option = select.options[select.selectedIndex];
            const fila = select.closest('tr');

            if (select.value === "") {
                fila.querySelector('.precio-unitario').value = "";
                fila.querySelector('.impuesto-producto').value = "";
            } else {
                const precio = option.getAttribute("data-precio") || 0;
                const impuesto = option.getAttribute("data-impuesto") || 0;
                fila.querySelector('.precio-unitario').value = parseFloat(precio).toFixed(2);
                fila.querySelector('.impuesto-producto').value = impuesto;
            }
            calcularSubtotalFila(fila.querySelector('.cantidad-input'));
        }

        // Función corregida para calcular subtotal por fila
        function calcularSubtotalFila(input) {
            const fila = input.closest('tr');
            const select = fila.querySelector('.producto-select');
            const option = select.options[select.selectedIndex];

            if (!option || select.value === "") return;

            const tipoVenta = option.getAttribute("data-tipo");
            let cant = parseFloat(fila.querySelector('.cantidad-input').value) || 0;
            const precio = parseFloat(fila.querySelector('.precio-unitario').value) || 0;

            if (tipoVenta === 'PESO') cant = cant / 1000;

            fila.querySelector('.subtotal-item').value = (cant * precio).toFixed(2);
            calcularTotal();
        }

        // Función corregida para sumar todos los subtotales
        function calcularTotal() {
            let subtotalGlobal = 0;
            let impuestoGlobal = 0;

            document.querySelectorAll('.detalle-item').forEach(fila => {
                const subtotalFila = parseFloat(fila.querySelector('.subtotal-item').value) || 0;
                const porcImpuesto = parseFloat(fila.querySelector('.impuesto-producto').value) || 0;

                subtotalGlobal += subtotalFila;
                impuestoGlobal += (subtotalFila * (porcImpuesto / 100));
            });

            document.getElementById('subtotalGeneral').value = subtotalGlobal.toFixed(2);
            document.getElementById('impuesto').value = impuestoGlobal.toFixed(2);
            document.getElementById('totalVenta').value = (subtotalGlobal + impuestoGlobal).toFixed(2);
        }
        function calcularDiferenciaCierre() {
            // Obtenemos los valores. Asegúrate de que estos IDs existan en tu HTML
            const montoEsperado = parseFloat(document.getElementById('montoEsperadoValue').value) || 0;
            const montoReal = parseFloat(document.getElementById('montoRealInput').value) || 0;

            const alertDiv = document.getElementById('alertDiferencia');
            const textoDif = document.getElementById('textoDiferencia');
            const mensajeDif = document.getElementById('mensajeDiferencia');
            const requiereObs = document.getElementById('requiereObservacion');

            // Si el usuario ingresó un monto real (aunque sea 0)
            if (document.getElementById('montoRealInput').value !== "") {
                const diferencia = montoReal - montoEsperado;
                const diferenciaAbsoluta = Math.abs(diferencia).toFixed(2);

                // Mostrar el contenedor principal
                alertDiv.style.display = 'block';

                // Lógica de comparación
                if (diferencia === 0) {
                    alertDiv.className = 'alert alert-success';
                    textoDif.className = 'mb-0 font-weight-bold text-success';
                    textoDif.textContent = "$ 0.00";
                    mensajeDif.textContent = '✓ Cuadre perfecto - No hay diferencia';
                    if(requiereObs) requiereObs.style.display = 'none';

                } else if (diferencia > 0) {
                    alertDiv.className = 'alert alert-warning';
                    textoDif.className = 'mb-0 font-weight-bold text-warning';
                    textoDif.textContent = "+ $ " + diferenciaAbsoluta;
                    mensajeDif.textContent = '⚠️ Sobrante en caja (Ingresó más de lo esperado)';
                    if(requiereObs) requiereObs.style.display = 'block';

                } else {
                    alertDiv.className = 'alert alert-danger';
                    textoDif.className = 'mb-0 font-weight-bold text-danger';
                    textoDif.textContent = "- $ " + diferenciaAbsoluta;
                    mensajeDif.textContent = '⚠️ Faltante en caja (Falta dinero según sistema)';
                    if(requiereObs) requiereObs.style.display = 'block';
                }
            } else {
                // Si el campo está vacío, ocultamos los avisos
                alertDiv.style.display = 'none';
                if(requiereObs) requiereObs.style.display = 'none';
            }
        }

        // Vincular el primer elemento manualmente (ya que no se crea por JS)
        document.querySelector('.producto-select').setAttribute('onchange', 'actualizarPrecioFila(this)');
        document.querySelector('.cantidad-input').setAttribute('onchange', 'calcularSubtotalFila(this)');
    </script>
</th:block>
</body>
</html>