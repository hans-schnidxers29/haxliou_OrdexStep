<!DOCTYPE html>
<html lang="es"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6"
      layout:decorate="~{layouts/adminlte}">
<head>
    <title>Registrar Venta</title>
    <style>
        .cliente-card {
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 15px;
            background-color: #f9f9f9;
            transition: all 0.3s;
        }
        .cliente-card.encontrado {
            border: 2px solid #28a745;
            background-color: #d4edda;
        }
        .cliente-info {
            display: none;
        }
        .cliente-info.show {
            display: block;
        }

        /* --- NUEVOS AJUSTES PARA LIBERAR NAVEGACI√ìN Y TECLADO --- */

        /* 1. Quitamos el desenfoque general que bloqueaba la vista */
        body.modal-open .content {
            filter: none !important;
        }

        /* 2. Hacemos que el fondo oscuro sea casi invisible para ver el Nav */
        .modal-backdrop {
            background-color: rgba(0,0,0,0.1) !important;
        }

        /* 3. Aseguramos que el modal no capture el foco de forma agresiva */
        #modalAbrirCaja {
            z-index: 1070 !important;
        }

        /* Estilo para resaltar que el modal es importante */
        #modalAbrirCaja .modal-content {
            border: 3px solid #007bff;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>

<div layout:fragment="content">
    <section class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1><i class="fas fa-cart-plus mr-2"></i> Nueva Venta</h1>
                </div>
            </div>
        </div>
    </section>




    <section class="content">
        <div class="container-fluid">
            <form th:action="@{/ventas/crear/nueva}" th:object="${venta}" method="POST" id="formVenta">
                <div class="row">
                    <div class="col-md-8">
                        <div class="card card-outline card-primary shadow">
                            <div class="card-header">
                                <h3 class="card-title font-weight-bold">
                                    <i class="fas fa-user-search mr-1"></i> Buscar Cliente
                                </h3>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="buscarNumeroId">
                                                <i class="fas fa-id-card mr-1"></i> N√∫mero de Identificaci√≥n
                                                <span class="text-danger">*</span>
                                            </label>
                                            <div class="input-group">
                                                <input type="text" id="buscarNumeroId" class="form-control form-control-lg" placeholder="Ingrese c√©dula o NIT..." autocomplete="off">
                                                <div class="input-group-append">
                                                    <button type="button" class="btn btn-primary btn-lg" onclick="buscarCliente()"><i class="fas fa-search"></i></button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="d-block">&nbsp;</label>
                                        <div class="cliente-card" id="clienteCard">
                                            <div class="text-center text-muted" id="clienteNoSeleccionado">
                                                <i class="fas fa-user-slash fa-2x mb-2"></i>
                                                <p class="mb-0">Sin cliente seleccionado</p>
                                            </div>
                                            <div class="cliente-info" id="clienteInfo">
                                                <h5 class="text-success mb-2"><i class="fas fa-check-circle mr-1"></i> Cliente Encontrado</h5>
                                                <p class="mb-1"><strong>Nombre:</strong> <span id="clienteNombre"></span></p>
                                                <p class="mb-1"><strong>Email:</strong> <span id="clienteEmail"></span></p>
                                                <p class="mb-0"><strong>Tel√©fono:</strong> <span id="clienteTelefono"></span></p>
                                            </div>
                                        </div>
                                        <input type="hidden" th:field="*{cliente.id}" id="clienteIdHidden">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card card-outline card-info shadow">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h3 class="card-title font-weight-bold">Detalle de Productos</h3>
                                <button type="button" class="btn btn-primary btn-sm ml-auto" onclick="agregarDetalle()">
                                    <i class="fas fa-plus mr-1"></i> Agregar Fila
                                </button>
                            </div>
                            <div class="card-body p-0">
                                <table class="table table-striped mb-0" id="tablaDetalles">
                                    <thead class="bg-info text-white">
                                    <tr>
                                        <th style="width: 45%">Producto</th>
                                        <th style="width: 15%">Cantidad (g/un)</th>
                                        <th style="width: 20%">Precio Unit.</th>
                                        <th style="width: 20%">Subtotal</th>
                                        <th style="width: 40px"></th>
                                    </tr>
                                    </thead>
                                    <tbody id="detallesContainer">
                                    <tr class="detalle-item">
                                        <td>
                                            <select name="detalles[0].producto.id" class="form-control producto-select" onchange="actualizarPrecio(0)" required>
                                                <option value="" disabled selected>-- Seleccione --</option>
                                                <option th:each="p : ${productos}" th:value="${p.id}" th:text="${p.nombre}" th:data-precio="${p.precio}" th:data-tipo="${p.tipoVenta.name()}"></option>
                                            </select>
                                        </td>
                                        <td><input type="number" name="detalles[0].cantidad" class="form-control" value="1" min="1" step="0.001" onchange="calcularSubtotal(0)" required></td>
                                        <td><input type="number" name="detalles[0].precioUnitario" class="form-control precio-unitario" readonly step="0.001" value="0.000"></td>
                                        <td><input type="number" name="detalles[0].subtotal" class="form-control subtotal-item" readonly step="0.001" value="0.000"></td>
                                        <td class="text-center"><button type="button" class="btn btn-link text-danger p-0" onclick="eliminarFila(this)"><i class="fas fa-times-circle"></i></button></td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="card card-primary card-outline shadow">
                            <div class="card-header">
                                <h3 class="card-title font-weight-bold">Datos de Facturaci√≥n</h3>
                            </div>
                            <div class="card-body">
                                <div class="form-group">
                                    <label>M√©todo de Pago <span class="text-danger">*</span></label>
                                    <select class="form-control" th:field="*{metodoPago}" id="metodoPagoSelect" required>
                                        <option value="" disabled selected>Seleccione pago...</option>
                                        <option value="EFECTIVO">Efectivo</option>
                                        <option value="TRANSFERENCIA">Transferencia</option>
                                        <option value="TARJETA">Tarjeta</option>
                                        <option value="MIXTO">Mixto</option>
                                    </select>
                                </div>
                                <hr>
                                <div class="bg-light p-3 rounded">
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Subtotal:</span>
                                        <input type="number" id="subtotalGeneral" class="form-control form-control-sm text-right border-0 bg-transparent font-weight-bold" readonly value="0.000">
                                    </div>
                                    <div class="form-group mb-2">
                                        <label class="small">Impuesto (%)</label>
                                        <input type="number" id="impuesto" th:field="*{impuesto}" class="form-control form-control-sm text-right" onchange="calcularTotal()" value="0">
                                    </div>
                                    <div class="d-flex justify-content-between text-lg text-primary font-weight-bold mt-3">
                                        <span>TOTAL:</span>
                                        <div>$ <input type="number" id="totalVenta" th:field="*{total}" class="d-inline text-right border-0 bg-transparent font-weight-bold text-primary" readonly style="width: 120px;"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-footer">

                                <button type="button"
                                        onclick="validarYProcesar()"
                                        class="btn btn-success btn-block shadow">
                                    <i class="fas fa-save mr-1"></i> Finalizar Venta
                                </button>

                                <a href="/ventas/listar" class="btn btn-default btn-block mt-2">
                                    Cancelar
                                </a>

                                <!-- BOTONES DE CAJA -->
                                <div th:if="${cajaAbierta != null}" class="mt-4">

                                    <button class="btn btn-danger btn-block shadow"
                                            data-toggle="modal"
                                            data-target="#modalCerrarCaja">
                                        <i class="fas fa-lock mr-1"></i> Cerrar Caja
                                    </button>

                                    <a th:if="${cajaAbierta != null}"
                                       th:href="@{/caja/cerrar/ticket/{id}(id=${cajaAbierta.id})}"
                                       target="_blank"
                                       class="btn btn-secondary btn-block mt-2 shadow">

                                    <i class="fas fa-print mr-1"></i> Imprimir Avance De Caja
                                    </a>


                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </form>
        </div>
    </section>

    <div th:if="${necesitaAbrirCaja}" class="modal fade" id="modalAbrirCaja"
         role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white text-center d-block">
                    <h5 class="modal-title font-weight-bold"><i class="fas fa-cash-register mr-2"></i> APERTURA DE CAJA</h5>
                    <button type="button" class="close text-white" onclick="window.location.href='/ventas/listar'" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <form th:action="@{/caja/abrir}" method="POST">
                    <div class="modal-body text-center py-4">
                        <p class="text-dark">Para registrar ventas, ingrese el <strong>monto base</strong>.</p>
                        <div class="form-group mb-0">
                            <label for="montoInicialInput" class="text-primary font-weight-bold">Efectivo Inicial:</label>
                            <div class="input-group input-group-lg shadow-sm">
                                <div class="input-group-prepend">
                                    <span class="input-group-text bg-white font-weight-bold text-success">$</span>
                                </div>
                                <input type="number" name="montoInicial" id="montoInicialInput"
                                       class="form-control text-center font-weight-bold"
                                       placeholder="0.00" step="0.01" min="0" required autofocus>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer bg-light border-0">
                        <button type="submit" class="btn btn-primary btn-block btn-lg shadow-sm">
                            <i class="fas fa-check-circle mr-1"></i> ABRIR CAJA AHORA
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade"
         id="modalCerrarCaja"
         tabindex="-1"
         th:if="${cajaAbierta != null}">

    <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">

                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-cash-register mr-1"></i> Cierre de Caja
                    </h5>
                    <button type="button" class="close text-white" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>

                <form th:action="@{/caja/cerrar}" method="POST">
                    <div class="modal-body">

                        <input type="hidden" name="id" th:value="${cajaAbierta.id}"/>

                        <!-- RESUMEN DE CAJA -->
                        <div class="border rounded p-3 mb-3 bg-light">

                            <p><strong>Base inicial:</strong>
                                $ <span th:text="${cajaAbierta.montoInicial}"></span>
                            </p>

                            <p><strong>Total ingresos:</strong>
                                $ <span th:text="${cajaAbierta.ingresoTotal}"></span>
                            </p>

                            <p><strong>Total egresos:</strong>
                                $ <span th:text="${cajaAbierta.egresosTotales}"></span>
                            </p>

                            <p><strong>Total gastos:</strong>
                                $ <span th:text="${cajaAbierta.gastosTotales}"></span>
                            </p>

                            <hr>

                            <p class="font-weight-bold text-primary">
                                Monto esperado:
                                $ <span id="montoEsperado"
                                        th:text="${cajaAbierta.montoEsperado}"></span>
                            </p>
                        </div>

                        <!-- MONTO REAL -->
                        <div class="form-group">
                            <label class="font-weight-bold">Monto real en caja</label>
                            <input type="number"
                                   id="montoRealInput"
                                   name="montoReal"
                                   class="form-control"
                                   step="0.01"
                                   min="0"
                                   required
                                   oninput="calcularDiferencia()">
                        </div>

                        <!-- DIFERENCIA -->
                        <div class="alert alert-info text-center">
                            <strong>Diferencia:</strong>
                            $ <span id="diferenciaCaja">0.00</span>
                        </div>

                    </div>



                    <div class="modal-footer">
                        <button type="button"
                                class="btn btn-danger btn-block"
                                onclick="cerrarCajaConTicket()">
                            <i class="fas fa-check mr-1"></i> Confirmar Cierre
                        </button>

                    </div>
                </form>

            </div>
        </div>
    </div>



</div>

<th:block layout:fragment="scripts">
    <script th:inline="javascript">

        const clientesData = /*[[${clientes}]]*/ [];
        let detalleCount = 1;

        $(document).ready(function () {

            const s = /*[[${success}]]*/ null;
            const e = /*[[${error}]]*/ null;
            const i = /*[[${info}]]*/ null;
            const w = /*[[${warning}]]*/ null;
            checkNotifications(s, e, i, w);

            const necesitaAbrir = /*[[${necesitaAbrirCaja}]]*/ false;
            if (necesitaAbrir) {
                $('#modalAbrirCaja').modal({
                    backdrop: 'static',
                    keyboard: true,
                    show: true
                });



                setTimeout(function() {
                    $('#montoInicialInput').focus();
                }, 800);
            }
        });

        async function validarYProcesar() {
            const necesitaAbrir = /*[[${necesitaAbrirCaja}]]*/ false;

            if (necesitaAbrir) {
                Swal.fire({
                    icon: 'error',
                    title: 'Caja cerrada',
                    text: 'Debe abrir la caja primero ingresando el monto inicial en el formulario azul.'
                });
                $('#modalAbrirCaja').modal('show');
                return;
            }

            const clienteId = document.getElementById('clienteIdHidden').value;
            if (!clienteId) {
                Swal.fire({ icon: 'warning', title: 'Cliente requerido', text: 'Debe seleccionar un cliente' });
                return;
            }
            document.getElementById('formVenta').submit();
        }

        function buscarCliente() {
            const numeroId = document.getElementById('buscarNumeroId').value.trim();
            if (!numeroId) { Swal.fire('Atenci√≥n', 'Ingrese un ID', 'warning'); return; }
            const clienteEncontrado = clientesData.find(c => c.numeroIdentificacion === numeroId);
            if (clienteEncontrado) { mostrarClienteEncontrado(clienteEncontrado); }
            else { Swal.fire({ title: 'No encontrado', text: '¬øRegistrar?', icon: 'question', showCancelButton: true }).then((r) => { if (r.isConfirmed) window.open('/crearcliente/nuevo', '_blank'); }); }
        }
        function mostrarClienteEncontrado(c) {
            document.getElementById('clienteIdHidden').value = c.id;
            document.getElementById('clienteNombre').textContent = c.nombre + ' ' + (c.apellido || '');
            document.getElementById('clienteEmail').textContent = c.email || 'N/A';
            document.getElementById('clienteTelefono').textContent = c.telefono || 'N/A';
            document.getElementById('clienteNoSeleccionado').style.display = 'none';
            document.getElementById('clienteInfo').classList.add('show');
            document.getElementById('clienteCard').classList.add('encontrado');
        }
        function agregarDetalle() {
            const container = document.getElementById('detallesContainer');
            const opciones = document.querySelector('.producto-select').innerHTML;
            const tr = document.createElement('tr');
            tr.className = "detalle-item";
            tr.innerHTML = `<td><select name="detalles[\${detalleCount}].producto.id" class="form-control producto-select" onchange="actualizarPrecio(\${detalleCount})" required>\${opciones}</select></td>
                <td><input type="number" name="detalles[\${detalleCount}].cantidad" class="form-control" value="1" min="1" step="0.001" onchange="calcularSubtotal(\${detalleCount})" required></td>
                <td><input type="number" name="detalles[\${detalleCount}].precioUnitario" class="form-control precio-unitario" readonly step="0.001"></td>
                <td><input type="number" name="detalles[\${detalleCount}].subtotal" class="form-control subtotal-item" readonly step="0.001"></td>
                <td class="text-center"><button type="button" class="btn btn-link text-danger p-0" onclick="eliminarFila(this)"><i class="fas fa-times-circle"></i></button></td>`;
            container.appendChild(tr);
            detalleCount++;
        }
        function eliminarFila(btn) {
            const filas = document.querySelectorAll('.detalle-item');
            if(filas.length > 1) {
                btn.closest('tr').remove();
                calcularTotal();
            } else {
                Swal.fire('Atenci√≥n', 'La venta debe tener al menos un producto', 'info');
            }
        }
        function actualizarPrecio(i) {
            const select = document.querySelector(`select[name="detalles[${i}].producto.id"]`);
            const precio = select.options[select.selectedIndex].getAttribute("data-precio");
            document.querySelector(`input[name="detalles[${i}].precioUnitario"]`).value = parseFloat(precio).toFixed(3);
            calcularSubtotal(i);
        }
        function calcularSubtotal(i) {
            const select = document.querySelector(`select[name="detalles[${i}].producto.id"]`);
            const tipoVenta = select.options[select.selectedIndex].getAttribute("data-tipo");
            let cant = parseFloat(document.querySelector(`input[name="detalles[${i}].cantidad"]`).value) || 0;
            const precio = parseFloat(document.querySelector(`input[name="detalles[${i}].precioUnitario"]`).value) || 0;
            if (tipoVenta === 'PESO') cant = cant / 1000;
            document.querySelector(`input[name="detalles[${i}].subtotal"]`).value = (cant * precio).toFixed(3);
            calcularTotal();
        }
        function calcularTotal() {
            let s = 0;
            document.querySelectorAll('.subtotal-item').forEach(i => s += parseFloat(i.value) || 0);
            const imp = parseFloat(document.getElementById('impuesto').value) || 0;
            document.getElementById('subtotalGeneral').value = s.toFixed(3);
            document.getElementById('totalVenta').value = (s + (s * (imp/100))).toFixed(3);
        }


        function calcularDiferencia() {
    const montoEsperado = parseFloat(
        document.getElementById('montoEsperado').innerText
    ) || 0;

    const montoReal = parseFloat(
        document.getElementById('montoRealInput').value
    ) || 0;

    const diferencia = montoReal - montoEsperado;

    const diffSpan = document.getElementById('diferenciaCaja');
    diffSpan.innerText = diferencia.toFixed(2);

    if (diferencia < 0) {
        diffSpan.style.color = 'red';
    } else {
        diffSpan.style.color = 'green';
    }
}

function cerrarCajaConTicket() {

    const idCaja = document.querySelector('input[name="id"]').value;
    const montoRealInput = document.getElementById('montoRealInput');
    const montoReal = montoRealInput.value;

    if (!montoReal || montoReal <= 0) {
        Swal.fire(
            'Monto requerido',
            'Debe ingresar el monto real en caja',
            'warning'
        );
        montoRealInput.focus();
        return;
    }

    // üñ®Ô∏è Abrir ticket en OTRA pesta√±a
    window.open(
        `/caja/cerrar/ticket/${idCaja}`,
        '_blank'
    );

    // üßæ Enviar el formulario para cerrar la caja
    document.querySelector('#modalCerrarCaja form').submit();
}



    </script>
</th:block>
</body>
</html>