<!DOCTYPE html>
<html lang="es"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6"
      layout:decorate="~{layouts/adminlte}">
<head>
    <title>Registrar Venta</title>
    <style>
        .cliente-card {
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 15px;
            background-color: #f9f9f9;
            transition: all 0.3s;
        }
        .cliente-card.encontrado {
            border: 2px solid #28a745;
            background-color: #d4edda;
        }
        .cliente-info {
            display: none;
        }
        .cliente-info.show {
            display: block;
        }
    </style>
</head>
<body>

<div layout:fragment="content">
    <section class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1><i class="fas fa-cart-plus mr-2"></i> Nueva Venta</h1>
                </div>
            </div>
        </div>
    </section>

    <section class="content">
        <div class="container-fluid">
            <form th:action="@{/ventas/crear/nueva}" th:object="${venta}" method="POST" id="formVenta">

                <div class="row">
                    <div class="col-md-8">
                        <!-- Card de búsqueda de cliente -->
                        <div class="card card-outline card-primary shadow">
                            <div class="card-header">
                                <h3 class="card-title font-weight-bold">
                                    <i class="fas fa-user-search mr-1"></i> Buscar Cliente
                                </h3>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="buscarNumeroId">
                                                <i class="fas fa-id-card mr-1"></i> Número de Identificación
                                                <span class="text-danger">*</span>
                                            </label>
                                            <div class="input-group">
                                                <input type="text"
                                                       id="buscarNumeroId"
                                                       class="form-control form-control-lg"
                                                       placeholder="Ingrese cédula o NIT..."
                                                       autocomplete="off">
                                                <div class="input-group-append">
                                                    <button type="button"
                                                            class="btn btn-primary btn-lg"
                                                            onclick="buscarCliente()">
                                                        <i class="fas fa-search"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            <small class="text-muted">Presione Enter o clic en Buscar</small>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="d-block">&nbsp;</label>
                                        <div class="cliente-card" id="clienteCard">
                                            <div class="text-center text-muted" id="clienteNoSeleccionado">
                                                <i class="fas fa-user-slash fa-2x mb-2"></i>
                                                <p class="mb-0">Sin cliente seleccionado</p>
                                            </div>
                                            <div class="cliente-info" id="clienteInfo">
                                                <h5 class="text-success mb-2">
                                                    <i class="fas fa-check-circle mr-1"></i> Cliente Encontrado
                                                </h5>
                                                <p class="mb-1">
                                                    <strong>Nombre:</strong> <span id="clienteNombre"></span>
                                                </p>
                                                <p class="mb-1">
                                                    <strong>Email:</strong> <span id="clienteEmail"></span>
                                                </p>
                                                <p class="mb-0">
                                                    <strong>Teléfono:</strong> <span id="clienteTelefono"></span>
                                                </p>
                                            </div>
                                        </div>
                                        <!-- Campo oculto con el ID del cliente -->
                                        <input type="hidden" name="cliente.id" id="clienteIdHidden">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Card de productos -->
                        <div class="card card-outline card-info shadow">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h3 class="card-title font-weight-bold">Detalle de Productos</h3>
                                <button type="button" class="btn btn-primary btn-sm ml-auto" onclick="agregarDetalle()">
                                    <i class="fas fa-plus mr-1"></i> Agregar Fila
                                </button>
                            </div>
                            <div class="card-body p-0">
                                <table class="table table-striped mb-0" id="tablaDetalles">
                                    <thead class="bg-info text-white">
                                    <tr>
                                        <th style="width: 45%">Producto</th>
                                        <th style="width: 15%">Cantidad (g/un)</th>
                                        <th style="width: 20%">Precio Unit.</th>
                                        <th style="width: 20%">Subtotal</th>
                                        <th style="width: 40px"></th>
                                    </tr>
                                    </thead>
                                    <tbody id="detallesContainer">
                                    <tr class="detalle-item">
                                        <td>
                                            <select name="detalles[0].producto.id" class="form-control producto-select" onchange="actualizarPrecio(0)" required>
                                                <option value="" disabled selected>-- Seleccione --</option>
                                                <option th:each="p : ${productos}"
                                                        th:value="${p.id}"
                                                        th:text="${p.nombre}"
                                                        th:data-precio="${p.precio}"
                                                        th:data-tipo="${p.tipoVenta.name()}"></option>
                                            </select>
                                        </td>
                                        <td>
                                            <input type="number" name="detalles[0].cantidad" class="form-control" value="1" min="1" step="0.001" onchange="calcularSubtotal(0)" required>
                                        </td>
                                        <td>
                                            <input type="number" name="detalles[0].precioUnitario" class="form-control precio-unitario" readonly step="0.001" value="0.000">
                                        </td>
                                        <td>
                                            <input type="number" name="detalles[0].subtotal" class="form-control subtotal-item" readonly step="0.001" value="0.000">
                                        </td>
                                        <td class="text-center">
                                            <button type="button" class="btn btn-link text-danger p-0" onclick="eliminarFila(this)"><i class="fas fa-times-circle"></i></button>
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="card card-primary card-outline shadow">
                            <div class="card-header">
                                <h3 class="card-title font-weight-bold">Datos de Facturación</h3>
                            </div>
                            <div class="card-body">
                                <div class="form-group">
                                    <label>Método de Pago <span class="text-danger">*</span></label>
                                    <select class="form-control" th:field="*{metodoPago}" id="metodoPagoSelect" required>
                                        <option value="" disabled selected>Seleccione pago...</option>
                                        <option value="EFECTIVO">Efectivo</option>
                                        <option value="TRANSFERENCIA">Transferencia</option>
                                        <option value="TARJETA">Tarjeta</option>
                                        <option value="MIXTO">Mixto</option>
                                    </select>
                                </div>
                                <hr>
                                <div class="bg-light p-3 rounded">
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Subtotal:</span>
                                        <input type="number" id="subtotalGeneral" class="form-control form-control-sm text-right border-0 bg-transparent font-weight-bold" readonly value="0.000">
                                    </div>
                                    <div class="form-group mb-2">
                                        <label class="small">Impuesto (%)</label>
                                        <input type="number" id="impuesto" th:field="*{impuesto}" class="form-control form-control-sm text-right" onchange="calcularTotal()" value="0">
                                    </div>
                                    <div class="d-flex justify-content-between text-lg text-primary font-weight-bold mt-3">
                                        <span>TOTAL:</span>
                                        <div>
                                            $ <input type="number" id="totalVenta" th:field="*{total}" class="d-inline text-right border-0 bg-transparent font-weight-bold text-primary" readonly style="width: 120px;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-footer">
                                <button type="button" onclick="validarYProcesar()" class="btn btn-success btn-block shadow">
                                    <i class="fas fa-save mr-1"></i> Finalizar Venta
                                </button>
                                <a href="/ventas/listar" class="btn btn-default btn-block mt-2">Cancelar</a>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </section>
</div>

<th:block layout:fragment="scripts">
    <script th:inline="javascript">
        // Lista de clientes desde el servidor
        const clientesData = /*[[${clientes}]]*/ [];
        let detalleCount = 1;

        // ===== FUNCIONES DE BÚSQUEDA DE CLIENTE =====
        function buscarCliente() {
            const numeroId = document.getElementById('buscarNumeroId').value.trim();

            if (!numeroId) {
                Swal.fire('Atención', 'Ingrese un número de identificación', 'warning');
                return;
            }

            // Buscar en la lista de clientes
            const clienteEncontrado = clientesData.find(c => c.numeroIdentificacion === numeroId);

            if (clienteEncontrado) {
                mostrarClienteEncontrado(clienteEncontrado);
            } else {
                Swal.fire({
                    title: 'Cliente no encontrado',
                    text: '¿Desea registrar un nuevo cliente?',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'Sí, registrar',
                    cancelButtonText: 'Cancelar'
                }).then((result) => {
                    if (result.isConfirmed) {
                        window.open('/crearcliente/nuevo', '_blank');
                    }
                });
                limpiarCliente();
            }
        }

        function mostrarClienteEncontrado(cliente) {
            // Actualizar el campo oculto con el ID
            document.getElementById('clienteIdHidden').value = cliente.id;

            // Mostrar información del cliente
            document.getElementById('clienteNombre').textContent = cliente.nombre + ' ' + (cliente.apellido || '');
            document.getElementById('clienteEmail').textContent = cliente.email || 'N/A';
            document.getElementById('clienteTelefono').textContent = cliente.telefono || 'N/A';

            // Cambiar estilos
            document.getElementById('clienteNoSeleccionado').style.display = 'none';
            document.getElementById('clienteInfo').classList.add('show');
            document.getElementById('clienteCard').classList.add('encontrado');

            // Mensaje de éxito
            Swal.fire({
                icon: 'success',
                title: 'Cliente encontrado',
                text: cliente.nombre,
                timer: 1500,
                showConfirmButton: false
            });
        }

        function limpiarCliente() {
            document.getElementById('clienteIdHidden').value = '';
            document.getElementById('clienteNoSeleccionado').style.display = 'block';
            document.getElementById('clienteInfo').classList.remove('show');
            document.getElementById('clienteCard').classList.remove('encontrado');
        }

        // Permitir buscar con Enter
        document.getElementById('buscarNumeroId').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                buscarCliente();
            }
        });

        // ===== FUNCIONES DE PRODUCTOS =====
        function agregarDetalle() {
            const container = document.getElementById('detallesContainer');
            const opciones = document.querySelector('.producto-select').innerHTML;

            const tr = document.createElement('tr');
            tr.className = "detalle-item";
            tr.innerHTML = `
                <td>
                    <select name="detalles[\${detalleCount}].producto.id" class="form-control producto-select" onchange="actualizarPrecio(\${detalleCount})" required>
                        \${opciones}
                    </select>
                </td>
                <td>
                    <input type="number" name="detalles[\${detalleCount}].cantidad" class="form-control" value="1" min="1" step="0.001" onchange="calcularSubtotal(\${detalleCount})" required>
                </td>
                <td>
                    <input type="number" name="detalles[\${detalleCount}].precioUnitario" class="form-control precio-unitario" readonly step="0.001">
                </td>
                <td>
                    <input type="number" name="detalles[\${detalleCount}].subtotal" class="form-control subtotal-item" readonly step="0.001">
                </td>
                <td class="text-center">
                    <button type="button" class="btn btn-link text-danger p-0" onclick="eliminarFila(this)"><i class="fas fa-times-circle"></i></button>
                </td>
            `;
            container.appendChild(tr);
            detalleCount++;
        }

        function eliminarFila(btn) {
            const filas = document.querySelectorAll('.detalle-item');
            if(filas.length > 1) {
                btn.closest('tr').remove();
                calcularTotal();
            } else {
                Swal.fire('Atención', 'La venta debe tener al menos un producto', 'info');
            }
        }

        function actualizarPrecio(i) {
            const select = document.querySelector(`select[name="detalles[${i}].producto.id"]`);
            const precio = select.options[select.selectedIndex].getAttribute("data-precio");
            document.querySelector(`input[name="detalles[${i}].precioUnitario"]`).value = parseFloat(precio).toFixed(3) || 0;
            calcularSubtotal(i);
        }

        function calcularSubtotal(i) {
            const select = document.querySelector(`select[name="detalles[${i}].producto.id"]`);
            const tipoVenta = select.options[select.selectedIndex].getAttribute("data-tipo");

            let cant = parseFloat(document.querySelector(`input[name="detalles[${i}].cantidad"]`).value) || 0;
            const precio = parseFloat(document.querySelector(`input[name="detalles[${i}].precioUnitario"]`).value) || 0;

            if (tipoVenta === 'PESO') {
                cant = cant / 1000;
            }

            const subtotal = cant * precio;
            document.querySelector(`input[name="detalles[${i}].subtotal"]`).value = subtotal.toFixed(3);
            calcularTotal();
        }

        function calcularTotal() {
            let subtotalGral = 0;
            document.querySelectorAll('.subtotal-item').forEach(input => {
                subtotalGral += parseFloat(input.value) || 0;
            });

            const impuestoPorcentaje = parseFloat(document.getElementById('impuesto').value) || 0;
            const totalFinal = subtotalGral + (subtotalGral * (impuestoPorcentaje / 100));

            document.getElementById('subtotalGeneral').value = subtotalGral.toFixed(3);
            document.getElementById('totalVenta').value = totalFinal.toFixed(3);
        }

        // ===== VALIDACIÓN Y ENVÍO =====
        async function validarYProcesar() {
            // Validar que hay cliente seleccionado
            const clienteId = document.getElementById('clienteIdHidden').value;
            if (!clienteId) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Cliente requerido',
                    text: 'Debe buscar y seleccionar un cliente antes de continuar',
                    confirmButtonText: 'Entendido'
                });
                document.getElementById('buscarNumeroId').focus();
                return;
            }

            const total = parseFloat(document.getElementById('totalVenta').value) || 0;
            const metodo = document.getElementById('metodoPagoSelect').value;

            if (total <= 0) {
                Swal.fire('Atención', 'No puede realizar una venta con total 0', 'warning');
                return;
            }

            if (metodo === 'EFECTIVO') {
                const { value: montoPagado } = await Swal.fire({
                    title: 'Calculadora de Cambio',
                    text: `Total a cobrar: $${total.toFixed(3)}`,
                    input: 'number',
                    inputLabel: '¿Con cuánto paga el cliente?',
                    inputAttributes: { step: '0.001' },
                    showCancelButton: true,
                    confirmButtonText: 'Ver Cambio',
                    inputValidator: (value) => {
                        if (!value || parseFloat(value) < total) {
                            return `El monto debe ser mayor o igual a $${total.toFixed(3)}`;
                        }
                    }
                });

                if (montoPagado) {
                    const cambio = parseFloat(montoPagado) - total;
                    await Swal.fire({
                        title: 'Cambio para el cliente:',
                        html: `<h1 class="text-success font-weight-bold">$ ${cambio.toFixed(3)}</h1>`,
                        confirmButtonText: 'LISTO',
                        icon: 'success'
                    });
                    document.getElementById('formVenta').submit();
                }
            } else {
                // Si no es efectivo (Tarjeta, Transferencia, etc) envía directo
                document.getElementById('formVenta').submit();
            }
        }

        $(document).ready(function () {
            const s = /*[[${success}]]*/ null;
            const e = /*[[${error}]]*/ null;
            const i = /*[[${info}]]*/ null;
            const w = /*[[${warning}]]*/ null;
            checkNotifications(s, e, i, w);
        });
    </script>
</th:block>

</body>
</html>