<!DOCTYPE html>
<html lang="es"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/adminlte}">
<head>
    <title>Listado de Pedidos</title>
    <style>
        /* Estilos originales preservados */
        .fila-entregado { border-left: 5px solid #28a745 !important; background-color: rgba(40, 167, 69, 0.05) !important; }
        .fila-cancelado { border-left: 5px solid #dc3545 !important; background-color: rgba(220, 53, 69, 0.05) !important; }
        .fila-pendiente { border-left: 5px solid #ffc107 !important; }
        .fila-procesando { border-left: 5px solid #007bff !important; }
        .fila-enviado { border-left: 5px solid #17a2b8 !important; }
        .badge-estado { padding: 5px 10px; border-radius: 15px; text-transform: uppercase; font-size: 0.75rem; }

        /* Mejora visual para las cards */
        .small-box { border-radius: 12px; overflow: hidden; }
        .small-box:hover { transform: translateY(-3px); transition: all 0.3s; shadow: 0 4px 15px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

<div layout:fragment="content">
    <section class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1 class="font-weight-bold"><i class="fas fa-shopping-cart mr-2 text-primary"></i> Gestión de Pedidos</h1>
                </div>
                <div class="col-sm-6 text-right">
                    <a th:href="@{/pedidos/nuevo}" class="btn btn-primary btn-lg shadow-sm">
                        <i class="fas fa-plus-circle mr-1"></i> Nuevo Pedido
                    </a>
                </div>
            </div>
        </div>
    </section>

    <section class="content">
        <div class="container-fluid">
            <div class="row">
                <div class="col-lg-3 col-6">
                    <div class="small-box bg-gradient-info elevation-2">
                        <div class="inner"><h3 th:text="${pedidos.size()}">0</h3><p>Total Pedidos</p></div>
                        <div class="icon"><i class="fas fa-shopping-bag"></i></div>
                    </div>
                </div>
                <div class="col-lg-3 col-6">
                    <div class="small-box bg-gradient-warning elevation-2">
                        <div class="inner"><h3 th:text="${Estadisticas} ?: '0'">0</h3><p>Pendientes</p></div>
                        <div class="icon"><i class="fas fa-clock"></i></div>
                    </div>
                </div>
                <div class="col-lg-3 col-6">
                    <div class="small-box bg-gradient-success elevation-2">
                        <div class="inner"><h3 th:text="${Estadisticas2} ?: '0'">0</h3><p>Entregados</p></div>
                        <div class="icon"><i class="fas fa-check-circle"></i></div>
                    </div>
                </div>
                <div class="col-lg-3 col-6">
                    <div class="small-box bg-gradient-danger elevation-2">
                        <div class="inner"><h3 th:text="${Estadisticas3} ?: '0'">0</h3><p>Cancelados</p></div>
                        <div class="icon"><i class="fas fa-times-circle"></i></div>
                    </div>
                </div>
            </div>
            <div class="card card-outline card-primary shadow"
                 th:if="${pedidos != null and !pedidos.isEmpty()}">

                <div class="card-header border-0 d-flex justify-content-between align-items-center">
                        <h3 class="card-title font-weight-bold">Listado General de Pedidos</h3>
                        <div class="card-tools ml-auto">
                            <button type="button" class="btn btn-outline-warning btn-sm shadow-sm" onclick="descargarPendientes()">
                                <i class="fas fa-file-excel mr-1"></i> Descargar Pendientes
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <table id="tablaPedidos" class="table table-bordered table-striped table-hover w-100">
                            <thead>
                            <tr>
                                <th>ID</th>
                                <th>Cliente</th>
                                <th>Fecha Pedido</th>
                                <th>Fecha Entrega</th>
                                <th>Productos</th>
                                <th>Total</th>
                                <th>Estado</th>
                                <th class="text-center">Acciones</th>
                                <th class="text-center">Imprimir POS</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="pedido : ${pedidos}"
                                th:class="${pedido.estado.name() == 'ENTREGADO'} ? 'fila-entregado' :
                                           (${pedido.estado.name() == 'CANCELADO'} ? 'fila-cancelado' :
                                           (${pedido.estado.name() == 'PENDIENTE'} ? 'fila-pendiente' : ''))">

                                <td th:text="'#' + ${pedido.id}" class="font-weight-bold"></td>
                                <td>
                                    <span th:text="${pedido.cliente.nombre}"></span><br>
                                    <small class="text-muted" th:text="${pedido.cliente.email}"></small>
                                </td>
                                <td>
                                    <span th:text="${#temporals.format(pedido.fechaPedido, 'dd/MM/yyyy')}"></span><br>
                                    <small class="text-muted" th:text="${#temporals.format(pedido.fechaPedido, 'HH:mm')}"></small>
                                </td>
                                <td>
                                    <span th:text="${#temporals.format(pedido.fechaEntrega, 'dd/MM/yyyy')}">Fecha</span>
                                </td>
                                <td>
                                    <span class="badge badge-info shadow-sm" th:text="${pedido.detalles.size()} + ' Items'"></span>
                                    <button type="button" class="btn btn-sm btn-default mr-1"
                                            data-toggle="modal" th:data-target="'#modalPedido' + ${pedido.id}" title="Ver Detalle Completo">
                                        <i class="fas fa-eye text-primary"></i>
                                    </button>
                                </td>
                                <td>
                                    <span class="text-primary font-weight-bold" th:text="'$' + ${#numbers.formatDecimal(pedido.total, 1, 'POINT', 2, 'COMMA')}"></span>
                                </td>
                                <td>
                                    <span class="badge badge-estado"
                                          th:classappend="${pedido.estado.name() == 'ENTREGADO' ? 'badge-success' :
                                                           (pedido.estado.name() == 'CANCELADO' ? 'badge-danger' :
                                                           (pedido.estado.name() == 'PENDIENTE' ? 'badge-warning' : 'badge-info'))}"
                                          th:text="${pedido.estado}"></span>
                                </td>
                                <td class="text-center">
                                    <div class="btn-group">

                                        <th:block th:if="${pedido.estado.name() != 'ENTREGADO' && pedido.estado.name() != 'CANCELADO'}">
                                            <a th:href="@{/pedidos/Entregar/{id}(id=${pedido.id})}" class="btn btn-success btn-sm" title="Entregar">
                                                <i class="fas fa-check"></i>
                                            </a>
                                            <a th:href="@{/pedidos/editar/{id}(id=${pedido.id})}" class="btn btn-info btn-sm">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <a th:href="@{/pedidos/Cancelar/{id}(id=${pedido.id})}" class="btn btn-danger btn-sm" title="Cancelar">
                                                <i class="fas fa-times"></i>
                                            </a>
                                        </th:block>
                                    </div>
                                </td>
                                <td>
                                    <div class="btn-group">
                                        <a th:href="@{/pedidos/generarTicket/{id}(id=${pedido.id})}" target="_blank" class="btn btn-default btn-sm ml-1">
                                            <i class="fas fa-print"></i> POS
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
            </div>

            <div class="card card-outline card-secondary shadow"
                 th:if="${pedidos == null or pedidos.isEmpty()}">

                <div class="card-body text-center py-5">

                    <i class="fas fa-shopping-cart fa-4x text-muted mb-3"></i>

                    <h4 class="text-muted font-weight-bold">
                        No hay pedidos registrados
                    </h4>

                    <p class="text-muted mb-4">
                        Aún no se han creado pedidos en el sistema.
                    </p>

                    <a th:href="@{/pedidos/nuevo}" class="btn btn-primary btn-lg shadow-sm">
                        <i class="fas fa-plus-circle mr-1"></i>
                        Crear primer pedido
                    </a>

                </div>
            </div>


        </div>
    </section>
    <div th:each="pedido : ${pedidos}">
        <div class="modal fade text-left" th:id="'modalPedido' + ${pedido.id}" tabindex="-1" role="dialog" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
                <div class="modal-content shadow-lg" style="border-radius: 15px; border: none;">

                    <div class="modal-header bg-gradient-primary text-white" style="border-radius: 15px 15px 0 0;">
                        <h5 class="modal-title font-weight-bold">
                            <i class="fas fa-shopping-bag mr-2"></i> Detalle de Pedido #[[${pedido.id}]]
                        </h5>
                        <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>

                    <div class="modal-body">
                        <div class="row mb-4 p-2 bg-light rounded shadow-sm mx-1">
                            <div class="col-md-4">
                                <label class="text-muted small text-uppercase d-block mb-0">Cliente</label>
                                <strong th:text="${pedido.cliente.nombre}"></strong>
                                <small class="d-block text-muted" th:text="${pedido.cliente.email}"></small>
                            </div>
                            <div class="col-md-4 border-left">
                                <label class="text-muted small text-uppercase d-block mb-0">Programación</label>
                                <span>Pedido: </span><strong th:text="${#temporals.format(pedido.fechaPedido, 'dd/MM/yyyy')}"></strong><br>
                                <span>Entrega: </span><strong class="text-primary" th:text="${#temporals.format(pedido.fechaEntrega, 'dd/MM/yyyy')}"></strong>
                            </div>
                            <div class="col-md-4 border-left text-right">
                                <label class="text-muted small text-uppercase d-block mb-0">Estado</label>
                                <span class="badge badge-estado"
                                      th:classappend="${pedido.estado.name() == 'ENTREGADO' ? 'badge-success' :
                               (pedido.estado.name() == 'CANCELADO' ? 'badge-danger' : 'badge-warning')}"
                                      th:text="${pedido.estado}"></span>
                            </div>
                        </div>

                        <div class="table-responsive" style="max-height: 350px;">
                            <table class="table table-hover table-sm">
                                <thead class="bg-secondary text-white">
                                <tr>
                                    <th class="pl-3">Producto</th>
                                    <th class="text-center">Cantidad</th>
                                    <th class="text-right">Precio Unit.</th>
                                    <th class="text-right pr-3">Subtotal</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr th:each="detalle : ${pedido.detalles}">
                                    <td class="pl-3 font-weight-bold" th:text="${detalle.producto.nombre}"></td>
                                    <td class="text-center">
                                        <span th:text="${detalle.cantidad}"></span>
                                        <small class="text-muted" th:text="${detalle.producto.tipoVenta.code == 'KGM' ? 'kg' : 'und'}"></small>
                                    </td>
                                    <td class="text-right" th:text="'$' + ${#numbers.formatDecimal(detalle.precioUnitario, 1, 'POINT', 2, 'COMMA')}"></td>
                                    <td class="text-right pr-3 font-weight-bold" th:text="'$' + ${#numbers.formatDecimal(detalle.subtotal, 1, 'POINT', 2, 'COMMA')}"></td>
                                </tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="row mt-3">
                            <div class="col-md-7">
                            </div>
                            <div class="col-md-5">
                                <div class="p-3 bg-light rounded border">
                                    <div class="d-flex justify-content-between mb-1">
                                        <span class="text-muted">Subtotal:</span>
                                        <span th:text="'$' + ${#numbers.formatDecimal(pedido.subtotal, 1, 'POINT', 2, 'COMMA')}"></span>
                                    </div>

                                    <div class="d-flex justify-content-between mb-1 text-danger">
                                        <span>Descuento (<span th:text="${pedido.descuento}">0</span>%):</span>
                                        <span th:text="'- $' + ${#numbers.formatDecimal(pedido.subtotal * (pedido.descuento / 100.0), 1, 'POINT', 2, 'COMMA')}"></span>
                                    </div>

                                    <div class="d-flex justify-content-between mb-1 text-muted small">
                                        <span>Impuestos (IVA):</span>
                                        <span th:text="'$' + ${#numbers.formatDecimal(pedido.impuesto, 1, 'POINT', 2, 'COMMA')}"></span>
                                    </div>

                                    <div class="d-flex justify-content-between mb-1">
                                        <span>Flete/Envío:</span>
                                        <span th:text="'$' + ${#numbers.formatDecimal(pedido.flete, 1, 'POINT', 2, 'COMMA')}"></span>
                                    </div>

                                    <hr class="my-2">

                                    <div class="d-flex justify-content-between align-items-center">
                                        <strong class="text-uppercase">Total:</strong>
                                        <h4 class="text-primary font-weight-bold mb-0"
                                            th:text="'$' + ${#numbers.formatDecimal(pedido.total, 1, 'POINT', 2, 'COMMA')}"></h4>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer bg-light d-flex justify-content-between" style="border-radius: 0 0 15px 15px;">
                        <div>
                            <a th:href="@{/pedidos/generarTicket/{id}(id=${pedido.id})}" class="btn btn-outline-info shadow-sm">
                                <i class="fas fa-print mr-1"></i> Imprimir Ticket POS
                            </a>
                        </div>
                        <div class="text-right">
                            <span class="text-muted mr-2">VALOR TOTAL:</span>
                            <span class="h4 text-primary font-weight-bold mb-0">
                            $[[${#numbers.formatDecimal(pedido.total, 1, 'COMMA', 2, 'POINT')}]]
                        </span>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<th:block layout:fragment="scripts">
    <script th:src="@{/plugins/chart.js/Chart.min.js}"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <script th:inline="javascript">
        $(document).ready(function () {
            // 1. Configuración DataTable
            $('#tablaPedidos').DataTable({
                "responsive": true,
                "autoWidth": false,
                "paging": true,
                "lengthChange": true,
                "searching": true,
                "ordering": true,
                "info": true,
                "language": {
                    "url": "https://cdn.datatables.net/plug-ins/1.10.24/i18n/Spanish.json"
                },
                "order": [ [ 0, "desc" ] ],
                "lengthMenu": [ [ 10, 25, 50, -1 ], [ 10, 25, 50, "Todos" ] ]
            });

            // 2. Notificaciones
            const s = /*[[${success}]]*/ null;
            const e = /*[[${error}]]*/ null;
            const i = /*[[${info}]]*/ null;
            const w = /*[[${warning}]]*/ null;
            checkNotifications(s, e, i, w);
        });

        // FUNCIÓN FUERA DEL READY PARA QUE SEA ACCESIBLE
        function descargarPendientes() {
            const listaPendientes = /*[[${pedidosPendientes}]]*/ [];

            if (!listaPendientes || listaPendientes.length === 0) {
                Swal.fire('Atención', 'No hay pedidos pendientes para exportar.', 'info');
                return;
            }

            try {
                const wb = XLSX.utils.book_new();
                // Usamos formato compatible con Thymeleaf
                const h = ["ID", "Cliente", "Fecha Pedido", "Total", "Estado"];
                const filas = listaPendientes.map(p => [
                    "#" + p.id,
                    p.cliente ? p.cliente.nombre : 'N/A',
                    p.fechaPedido ? p.fechaPedido.toString().split('T')[0] : 'N/A',
                    p.total,
                    "PENDIENTE"
                ]);

                const ws = XLSX.utils.aoa_to_sheet([h].concat(filas));
                ws['!cols'] = [{wch: 10}, {wch: 30}, {wch: 20}, {wch: 15}, {wch: 15}];
                XLSX.utils.book_append_sheet(wb, ws, "Pendientes");

                const hoy = new Date().toISOString().slice(0, 10);
                XLSX.writeFile(wb, "Pedidos_Pendientes_" + hoy + ".xlsx");
                Swal.fire('Éxito', 'Descarga iniciada', 'success');
            } catch (error) {
                console.error("Error:", error);
                Swal.fire('Error', 'No se pudo generar el Excel', 'error');
            }
        }
    </script>
</th:block>

</body>
</html>