<!DOCTYPE html>
<html lang="es"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/adminlte}">
<head>
    <title>Listado de Pedidos</title>
    <style>
        .fila-entregado { border-left: 5px solid #28a745 !important; background-color: rgba(40, 167, 69, 0.05) !important; }
        .fila-cancelado { border-left: 5px solid #dc3545 !important; background-color: rgba(220, 53, 69, 0.05) !important; }
        .fila-pendiente { border-left: 5px solid #ffc107 !important; }
        .fila-procesando { border-left: 5px solid #007bff !important; }
        .fila-enviado { border-left: 5px solid #17a2b8 !important; }
        .badge-estado { padding: 5px 10px; border-radius: 15px; text-transform: uppercase; font-size: 0.75rem; }
    </style>
</head>
<body>

<div layout:fragment="content">
    <section class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1><i class="fas fa-shopping-cart mr-2"></i> Gesti√≥n de Pedidos</h1>
                </div>
                <div class="col-sm-6 text-right">
                    <a th:href="@{/pedidos/nuevo}" class="btn btn-primary shadow-sm">
                        <i class="fas fa-plus mr-1"></i> Nuevo Pedido
                    </a>
                </div>
            </div>
        </div>
    </section>

    <section class="content">
        <div class="container-fluid">
            <div class="row">
                <div class="col-lg-3 col-6">
                    <div class="small-box bg-info shadow">
                        <div class="inner"><h3 th:text="${pedidos.size()}">0</h3><p>Total Pedidos</p></div>
                        <div class="icon"><i class="fas fa-shopping-bag"></i></div>
                    </div>
                </div>
                <div class="col-lg-3 col-6">
                    <div class="small-box bg-warning shadow">
                        <div class="inner"><h3 th:text="${Estadisticas} ?: '0'">0</h3><p>Pendientes</p></div>
                        <div class="icon"><i class="fas fa-clock"></i></div>
                    </div>
                </div>
                <div class="col-lg-3 col-6">
                    <div class="small-box bg-success shadow">
                        <div class="inner"><h3 th:text="${Estadisticas2} ?: '0'">0</h3><p>Entregados</p></div>
                        <div class="icon"><i class="fas fa-check-circle"></i></div>
                    </div>
                </div>
                <div class="col-lg-3 col-6">
                    <div class="small-box bg-danger shadow">
                        <div class="inner"><h3 th:text="${Estadisticas3} ?: '0'">0</h3><p>Cancelados</p></div>
                        <div class="icon"><i class="fas fa-times-circle"></i></div>
                    </div>
                </div>
            </div>

            <div class="card card-outline card-primary shadow">
                <div class="card-header">
                    <h3 class="card-title">Listado General de Pedidos</h3>
                </div>
                <div class="card-body">
                    <table id="tablaPedidos" class="table table-bordered table-striped table-hover w-100">
                        <thead>
                        <tr>
                            <th>ID</th>
                            <th>Cliente</th>
                            <th>Fecha Pedido</th>
                            <th>Fecha Entrega</th>
                            <th>Productos</th>
                            <th>Total</th>
                            <th>Estado</th>
                            <th class="text-center">Acciones</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="pedido : ${pedidos}"
                            th:class="${pedido.estado.name() == 'ENTREGADO'} ? 'fila-entregado' :
                                       (${pedido.estado.name() == 'CANCELADO'} ? 'fila-cancelado' :
                                       (${pedido.estado.name() == 'PENDIENTE'} ? 'fila-pendiente' : ''))">

                            <td th:text="'#' + ${pedido.id}" class="font-weight-bold"></td>
                            <td>
                                <span th:text="${pedido.cliente.nombre}"></span><br>
                                <small class="text-muted" th:text="${pedido.cliente.email}"></small>
                            </td>
                            <td>
                                <span th:text="${#temporals.format(pedido.fechaPedido, 'dd/MM/yyyy')}"></span><br>
                                <small class="text-muted" th:text="${#temporals.format(pedido.fechaPedido, 'HH:mm')}"></small>
                            </td>
                            <td>
                                <span th:text="${#temporals.format(pedido.fechaEntrega, 'dd/MM/yyyy')}">Fecha</span>
                            </td>
                            <td>
                                <span class="badge badge-info" th:text="${pedido.detalles.size()} + ' item(s)'"></span>
                                <br>
                                <small class="text-muted">
                                 <span th:each="detalle, iterStat : ${pedido.detalles}">
                                 <span th:text="${detalle.cantidad} + 'x ' + ${detalle.producto.nombre}"></span>
                                 <span th:if="${!iterStat.last}">, </span>
                                 </span>
                                </small>
                            </td>
                            <td>
                                <span class="text-primary font-weight-bold" th:text="'$' + ${#numbers.formatDecimal(pedido.total, 1, 3)}"></span>
                            </td>
                            <td>
                                <span class="badge badge-estado"x
                                      th:classappend="${pedido.estado.name() == 'ENTREGADO' ? 'badge-success' :
                                                       (pedido.estado.name() == 'CANCELADO' ? 'badge-danger' :
                                                       (pedido.estado.name() == 'PENDIENTE' ? 'badge-warning' : 'badge-info'))}"
                                      th:text="${pedido.estado}"></span>
                            </td>
                            <td class="text-center">
                                <div class="btn-group">
                                    <th:block th:if="${pedido.estado.name() != 'ENTREGADO' && pedido.estado.name() != 'CANCELADO'}">
                                        <a th:href="@{/pedidos/Entregar/{id}(id=${pedido.id})}" class="btn btn-success btn-sm" title="Entregar">
                                            <i class="fas fa-check"></i>
                                        </a>
                                        <a th:href="@{/pedidos/editar/{id}(id=${pedido.id})}" class="btn btn-info btn-sm">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <a th:href="@{/pedidos/Cancelar/{id}(id=${pedido.id})}" class="btn btn-danger btn-sm" title="Cancelar">
                                            <i class="fas fa-times"></i>
                                        </a>
                                    </th:block>
                                    <a th:href="@{/pedidos/ver/{id}(id=${pedido.id})}" class="btn btn-default btn-sm ml-1">
                                        <i class="fas fa-print"></i> POS
                                    </a>
                                </div>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </section>
</div>

<th:block layout:fragment="scripts">
    <script>
        $(document).ready(function () {
            $('#tablaPedidos').DataTable({
                "responsive": true,
                "autoWidth": false,
                "paging": true,
                "lengthChange": true,
                "searching": true,
                "ordering": true,
                "info": true,
                "language": {
                    "url": "https://cdn.datatables.net/plug-ins/1.10.24/i18n/Spanish.json"
                },
                // ESPACIOS CLAVE: [ [ 0, "desc" ] ] para evitar error de Thymeleaf
                "order": [ [ 0, "desc" ] ],
                "lengthMenu": [ [ 10, 25, 50, -1 ], [ 10, 25, 50, "Todos" ] ]
            });
        });
    </script>
</th:block>

</body>
</html>