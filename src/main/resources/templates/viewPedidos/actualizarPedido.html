<!DOCTYPE html>
<html lang="es"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/adminlte}">
<head>
    <title>Editar Pedido</title>
    <style>
        .cliente-card {
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 12px;
            background-color: #f9f9f9;
            transition: all 0.3s;
        }
        .cliente-card.encontrado {
            border: 2px solid #28a745;
            background-color: #d4edda;
        }
        .cliente-card.actual {
            border: 2px solid #007bff;
            background-color: #e3f2fd;
        }
        .cliente-info { display: none; }
        .cliente-info.show { display: block; }

        .sticky-resumen {
            position: -webkit-sticky;
            position: sticky;
            top: 20px;
            z-index: 1020;
        }

        .resumen-compacto .card-body {
            padding: 12px !important;
        }

        .resumen-compacto .form-group {
            margin-bottom: 8px !important;
        }

        .total-box-mini {
            background-color: #f8f9fa;
            border-radius: 5px;
            padding: 10px;
            border: 1px solid #dee2e6;
        }

        .total-final-mini {
            font-size: 1.3rem;
            color: #007bff;
            font-weight: bold;
        }

        .table td, .table th {
            padding: 0.6rem !important;
            vertical-align: middle !important;
            font-size: 0.9rem;
        }

        .form-control-sm {
            height: calc(1.8rem + 2px);
        }

        .badge-pedido {
            font-size: 0.9rem;
            padding: 5px 10px;
        }
    </style>
</head>
<body>

<div layout:fragment="content">
    <section class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1>
                        <i class="fas fa-edit mr-2"></i> Editar Pedido
                        <span class="badge badge-info badge-pedido" th:text="'#' + ${pedido.id}"></span>
                    </h1>
                </div>
                <div class="col-sm-6 text-right">
                    <a th:href="@{/pedidos/listarpedidos}" class="btn btn-secondary btn-sm">
                        <i class="fas fa-arrow-left mr-1"></i> Volver
                    </a>
                </div>
            </div>
        </div>
    </section>

    <section class="content">
        <div class="container-fluid">
            <form th:action="@{/pedidos/actualizar/{id}(id=${pedido.id})}" th:object="${pedido}" method="POST" id="formPedido">
                <input type="hidden" th:field="*{id}">

                <div class="row">
                    <div class="col-md-9">
                        <div class="card card-primary card-outline shadow mb-3">
                            <div class="card-header py-2">
                                <h3 class="card-title font-weight-bold"><i class="fas fa-user-search mr-1"></i> Cliente</h3>
                            </div>
                            <div class="card-body">
                                <!-- Cliente Actual -->
                                <div class="alert alert-light py-2 mb-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong><i class="fas fa-user-circle mr-1"></i> Cliente Actual:</strong>
                                            <span th:text="${pedido.cliente.nombre} + ' ' + (${pedido.cliente.apellido} ?: '')"></span>
                                            <br>
                                            <small class="text-muted">
                                                ID: <span th:text="${pedido.cliente.numeroIdentificacion}"></span> |
                                                Tel: <span th:text="${pedido.cliente.telefono} ?: 'N/A'"></span>
                                                Email: <span th:text="${pedido.cliente.email} ?: 'N/A'"></span>
                                            </small>
                                        </div>
                                        <span class="badge badge-primary badge-pill">Asignado</span>
                                    </div>
                                </div>

                                    <div class="row">
                                        <div class="col-md-7">
                                            <div class="form-group mb-2">
                                                <label class="small">Cambiar Cliente (Opcional)</label>
                                                <div class="input-group input-group-sm">
                                                    <input type="text" id="buscarNumeroId" class="form-control" placeholder="Buscar por cédula o NIT...">
                                                    <div class="input-group-append">
                                                        <button type="button" class="btn btn-primary" onclick="buscarCliente()">
                                                            <i class="fas fa-search"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="form-group mb-0">
                                                <label class="small">Fecha de Entrega <span class="text-danger">*</span></label>
                                                <input type="datetime-local" th:field="*{fechaEntrega}" class="form-control form-control-sm" required>
                                            </div>
                                        </div>
                                        <div class="col-md-5">
                                            <div class="cliente-card" id="clienteCard" style="display: none;">
                                                <div class="cliente-info show" id="clienteInfo">
                                                    <p class="mb-1 font-weight-bold text-success small">
                                                        <i class="fas fa-user-check"></i> Nuevo Cliente:
                                                    </p>
                                                    <div id="clienteNombre" class="font-weight-bold"></div>
                                                    <div id="clienteTelefono" class="small text-muted"></div>
                                                    <div id="clienteEmail" class="small text-muted"></div>
                                                    <button type="button" class="btn btn-sm btn-outline-danger btn-block mt-2" onclick="cancelarCambioCliente()">
                                                        <i class="fas fa-times"></i> Cancelar
                                                    </button>
                                                </div>
                                            </div>
                                            <input type="hidden" th:field="*{cliente.id}" id="clienteIdHidden">
                                        </div>
                                    </div>
                            </div>
                        </div>

                        <div class="card card-info shadow">
                            <div class="card-header d-flex justify-content-between align-items-center py-2">
                                <h3 class="card-title font-weight-bold small"><i class="fas fa-boxes mr-1"></i> Ítems</h3>
                                <button type="button" class="btn btn-primary btn-xs ml-auto" onclick="agregarDetalle()">
                                    <i class="fas fa-plus"></i> Añadir
                                </button>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-sm table-striped mb-0">
                                        <thead class="bg-light">
                                        <tr>
                                            <th>Categoría</th>
                                            <th>Producto</th>
                                            <th style="width: 120px;">Cantidad</th>
                                            <th>P. Unit (Ref)</th>
                                            <th>IVA % (Ref)</th>
                                            <th>Subtotal (Ref)</th>
                                            <th style="width: 40px;"></th>
                                        </tr>
                                        </thead>
                                        <tbody id="detallesContainer">
                                        <tr class="detalle-item" th:each="detalle, iterStat : ${pedido.detalles}">
                                            <!-- Agregamos una clase al ID oculto para encontrarlo fácil al reindexar -->
                                            <input type="hidden" class="detalle-id" th:name="'detalles[' + ${iterStat.index} + '].id'" th:value="${detalle.id}">
                                            <td>
                                                <select class="form-control form-control-sm categoria-filter" onchange="filtrarProductos(this)">
                                                    <option value="">-- Todas --</option>
                                                    <option th:each="cat : ${categoria}"
                                                            th:value="${cat.id}"
                                                            th:text="${cat.nombre}"
                                                            th:selected="${cat.id == detalle.producto.categoria.id}"></option>
                                                </select>
                                            </td>
                                            <td>
                                                <select th:name="'detalles[' + ${iterStat.index} + '].producto.id'"
                                                        class="form-control form-control-sm producto-select"
                                                        required
                                                        onchange="actualizarPrecioByElement(this)">
                                                    <option value="" disabled>-- Seleccionar --</option>
                                                    <option th:each="p : ${productos}"
                                                            th:value="${p.id}"
                                                            th:text="${p.nombre}"
                                                            th:data-categoria="${p.categoriaId}"
                                                            th:data-precio="${p.precio}"
                                                            th:data-preciomayor="${p.precioPorMayor}"
                                                            th:data-impuesto="${p.impuesto}"
                                                            th:data-tipo="${p.tipoVenta}"
                                                            th:selected="${p.id == detalle.producto.id}"></option>
                                                </select>
                                            </td>
                                            <td>
                                                <div class="input-group input-group-sm">
                                                    <input type="number"
                                                           th:name="'detalles[' + ${iterStat.index} + '].cantidad'"
                                                        th:value="${detalle.producto.tipoVenta.code == 'KGM' ? detalle.cantidad * 1000 : detalle.cantidad}"
                                                        class="form-control cantidad-input"
                                                        min="0.01"
                                                        step="any"
                                                        required
                                                        onchange="calcularSubtotalByElement(this)">
                                                    <div class="input-group-append">
                                                    <span class="input-group-text unidad-label p-1"
                                                          style="font-size: 0.7rem;"
                                                          th:text="${detalle.producto.tipoVenta.code == 'KGM' ? 'gr' : (detalle.producto.tipoVenta.code == 'LTR' ? 'ml' : 'un')}">
                                                        </span>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <input type="text"
                                                       class="form-control form-control-sm precio-unitario-display bg-light text-right"
                                                       th:value="${#numbers.formatDecimal(detalle.precioUnitario, 1, 'POINT', 2, 'COMMA')}"
                                                       readonly>
                                            </td>
                                            <td>
                                                <input type="text"
                                                       class="form-control form-control-sm impuesto-display bg-light text-right"
                                                       th:value="${detalle.porcentajeImpuesto} + '%'"
                                                       readonly>
                                            </td>
                                            <td>
                                                <input type="text"
                                                       class="form-control form-control-sm subtotal-display bg-light font-weight-bold text-right"
                                                       th:value="${#numbers.formatDecimal(detalle.subtotal, 1, 'POINT', 2, 'COMMA')}"
                                                       readonly>
                                            </td>
                                            <td class="text-center">
                                                <button type="button" class="btn btn-link text-danger p-0 btn-eliminar" onclick="eliminarDetalle(this)">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-3">
                        <div class="sticky-resumen">
                            <div class="card shadow resumen-compacto border-primary">
                                <div class="card-header bg-primary py-2 text-center">
                                    <h3 class="card-title float-none font-weight-bold" style="font-size: 0.9rem;">Resumen</h3>
                                </div>
                                <div class="card-body">
                                    <div class="form-group mb-3 text-center border-bottom pb-2">
                                        <label class="d-block small font-weight-bold text-primary mb-1 text-uppercase">Tipo de Precio</label>
                                        <div class="custom-control custom-switch custom-switch-off-danger custom-switch-on-success">
                                            <input type="checkbox" th:field="*{ventaPorMayor}" class="custom-control-input" id="switchVentaMayor" onchange="alternarPreciosGlobal()">
                                            <label class="custom-control-label" for="switchVentaMayor">
                                            <span id="labelVenta" class="small font-weight-bold"
                                                  th:text="${pedido.ventaPorMayor ? 'Precio MAYORISTA' : 'Precio DETAL'}"
                                                  th:classappend="${pedido.ventaPorMayor ? 'text-success' : 'text-danger'}"></span>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="d-flex justify-content-between mb-1">
                                        <span class="text-muted small">Subtotal:</span>
                                        <span class="small font-weight-bold">$ <span id="totalSubtotalLabel" th:text="${#numbers.formatDecimal(pedido.subtotal, 1, 'POINT', 2, 'COMMA')}">0.00</span></span>
                                    </div>
                                    <div class="form-group mb-2">
                                        <label class="small mb-0">Costo Envío / Flete</label>
                                        <input type="number"
                                               th:field="*{flete}"
                                               class="form-control form-control-sm"
                                               step="0.01"
                                               min="0"
                                               onchange="calcularTotal()"
                                               placeholder="0.00">
                                    </div>
                                    <div class="d-flex justify-content-between mb-1">
                                        <span class="text-muted small">IVA Total:</span>
                                        <span class="small font-weight-bold">$ <span id="totalImpuestosLabel" th:text="${#numbers.formatDecimal(pedido.impuesto, 1, 'POINT', 2, 'COMMA')}">0.00</span></span>
                                    </div>
                                    <div class="form-group mb-2 border-top pt-2">
                                        <label class="small font-weight-bold text-danger">DESCUENTO (%)</label>
                                        <div class="input-group input-group-sm">
                                            <div class="input-group-prepend">
                                                <span class="input-group-text bg-danger text-white border-danger"><i class="fas fa-percent"></i></span>
                                            </div>
                                            <input type="number"
                                                   th:field="*{descuento}"
                                                   id="inputDescuento"
                                                   class="form-control text-right font-weight-bold border-danger"
                                                   placeholder="0" min="0" max="100" step="0.1"
                                                   oninput="calcularTotal()">
                                        </div>
                                        <div class="text-right small text-danger mt-1">
                                            - $ <span id="valorDescuentoCalculado">0.00</span>
                                        </div>
                                    </div>
                                    <hr class="my-2">
                                    <div class="total-box-mini text-center mb-3">
                                        <span class="d-block text-muted small text-uppercase" style="font-size: 0.65rem;">Total a Pagar</span>
                                        <span class="total-final-mini">$ <span id="totalPedidoLabel" th:text="${#numbers.formatDecimal(pedido.total, 1, 'POINT', 2, 'COMMA')}">0.00</span></span>
                                    </div>
                                    <div class="alert alert-warning alert-sm py-2 px-2 mb-2" style="font-size: 0.7rem;">
                                        <i class="fas fa-info-circle"></i> <strong>Nota:</strong> Los valores mostrados son referenciales. El sistema calculará automáticamente los totales finales al guardar.
                                    </div>

                                    <button type="submit" class="btn btn-success btn-block shadow-sm font-weight-bold">
                                        <i class="fas fa-save mr-1"></i> ACTUALIZAR PEDIDO
                                    </button>
                                    <a th:href="@{/pedidos/listarpedidos}" class="btn btn-xs btn-outline-secondary btn-block mt-2">Cancelar</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </section>
</div>

<th:block layout:fragment="scripts">
    <script th:inline="javascript">
        const clientesData = /*[[${clientes}]]*/ [];
        const productosData = /*[[${productosData}]]*/ [];
        const categoriasData = /*[[${categoriaData}]]*/ [];

        const clienteOriginalId = /*[[${pedido.cliente.id}]]*/ null;
        let detalleCount = /*[[${pedido.detalles.size()}]]*/ 1;

        function filtrarProductos(selectCategoria) {
            const categoriaId = selectCategoria.value;
            const fila = selectCategoria.closest('tr');
            const selectProducto = fila.querySelector('.producto-select');
            const valorActual = selectProducto.value;
            const opciones = selectProducto.querySelectorAll('option');

            opciones.forEach(opt => {
                if (opt.value === "") return;
                const productoCatId = opt.getAttribute('data-categoria');
                if (categoriaId === "" || productoCatId === categoriaId) {
                    opt.style.display = "block";
                    opt.disabled = false;
                } else {
                    opt.style.display = "none";
                    opt.disabled = true;
                }
            });

            if (valorActual && categoriaId !== "") {
                const optActual = selectProducto.querySelector(`option[value="${valorActual}"]`);
                if (optActual && optActual.disabled) {
                    selectProducto.value = "";
                    actualizarPrecio(fila.rowIndex - 1);
                }
            }
        }

        function buscarCliente() {
            const numeroId = document.getElementById('buscarNumeroId').value.trim();
            if (!numeroId) {
                Swal.fire('Error', 'Ingrese identificación', 'error');
                return;
            }

            const cliente = clientesData.find(c => c.numeroIdentificacion === numeroId);
            if (cliente) {
                if (cliente.id === clienteOriginalId) {
                    Swal.fire('Información', 'Este ya es el cliente actual del pedido', 'info');
                    document.getElementById('buscarNumeroId').value = '';
                    return;
                }

                document.getElementById('clienteIdHidden').value = cliente.id;
                document.getElementById('clienteNombre').textContent = cliente.nombre + ' ' + (cliente.apellido || '');
                document.getElementById('clienteTelefono').textContent = "Tel: " + (cliente.telefono || 'N/A');
                document.getElementById('clienteEmail').textContent = cliente.email || 'N/A';
                document.getElementById('clienteCard').style.display = 'block';
                document.getElementById('clienteInfo').classList.add('show');
                document.getElementById('clienteCard').classList.add('encontrado');
                Swal.fire({ icon: 'success', title: 'Cliente Encontrado', timer: 1000, showConfirmButton: false });

                Swal.fire({
                    icon: 'success',
                    title: 'Cliente cambiado',
                    text: 'Recuerde guardar los cambios para confirmar',
                    timer: 2000
                });
            } else {
                Swal.fire({
                    title: 'No existe',
                    text: '¿Registrar nuevo cliente?',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'Sí, registrar',
                    cancelButtonText: 'Cancelar'
                }).then((r) => {
                    if (r.isConfirmed) window.open('/crearcliente/nuevo', '_blank');
                });
            }
        }

        function cancelarCambioCliente() {
            document.getElementById('clienteIdHidden').value = clienteOriginalId;
            document.getElementById('buscarNumeroId').value = '';
            document.getElementById('clienteCard').style.display = 'none';
            document.getElementById('clienteCard').classList.remove('encontrado');
            Swal.fire({
                icon: 'info',
                title: 'Cancelado',
                text: 'Se mantendrá el cliente original',
                timer: 1500
            });
        }

        function reindexarDetalles() {
            document.querySelectorAll('#detallesContainer tr').forEach((row, index) => {
                // 1. Actualizar ID oculto de la entidad DetallePedido (si existe)
                const inputId = row.querySelector('.detalle-id');
                if (inputId) {
                    inputId.setAttribute('name', `detalles[${index}].id`);
                }

                // 2. Actualizar Select de Producto
                const selectProd = row.querySelector('.producto-select');
                if (selectProd) {
                    selectProd.setAttribute('name', `detalles[${index}].producto.id`);
                }

                // 3. Actualizar Input de Cantidad
                const inputCant = row.querySelector('.cantidad-input');
                if (inputCant) {
                    inputCant.setAttribute('name', `detalles[${index}].cantidad`);
                }
            });
            console.log("Sincronización de índices completada para " + document.querySelectorAll('#detallesContainer tr').length + " ítems.");
        }

        function agregarDetalle() {
            const container = document.getElementById('detallesContainer');

            // Obtenemos el HTML de las opciones de los selectores existentes
            const opcionesCat = document.querySelector('.categoria-filter').innerHTML;
            const opcionesProd = document.querySelector('.producto-select').innerHTML;

            const tr = document.createElement('tr');
            tr.className = 'detalle-item';
            tr.innerHTML = `
                <td><select class="form-control form-control-sm categoria-filter" onchange="filtrarProductos(this)">${opcionesCat}</select></td>
                <td><select name="detalles[0].producto.id" class="form-control form-control-sm producto-select" required onchange="actualizarPrecioByElement(this)">${opcionesProd}</select></td>
                <td>
                    <div class="input-group input-group-sm">
                        <input type="number" name="detalles[0].cantidad" class="form-control cantidad-input" min="0.01" value="1" step="any" required onchange="calcularSubtotalByElement(this)">
                        <div class="input-group-append"><span class="input-group-text unidad-label p-1" style="font-size: 0.7rem;">un</span></div>
                    </div>
                </td>
                <td><input type="text" class="form-control form-control-sm bg-light text-right precio-unitario-display" readonly tabindex="-1"></td>
                <td><input type="text" class="form-control form-control-sm bg-light text-right impuesto-display" readonly tabindex="-1"></td>
                <td><input type="text" class="form-control form-control-sm bg-light font-weight-bold text-right subtotal-display" readonly tabindex="-1"></td>
                <td class="text-center"><button type="button" class="btn btn-link text-danger p-0" onclick="eliminarDetalle(this)"><i class="fas fa-trash"></i></button></td>
            `;
            container.appendChild(tr);
            reindexarDetalles();
        }

        function actualizarPrecioByElement(selectElement) {
            const row = selectElement.closest('tr');
            const rowIndex = Array.from(row.parentNode.children).indexOf(row);
            actualizarPrecio(rowIndex);
        }

        function calcularSubtotalByElement(inputElement) {
            const row = inputElement.closest('tr');
            const rowIndex = Array.from(row.parentNode.children).indexOf(row);
            calcularSubtotal(rowIndex);
        }

        // NUEVO: faltaba esta función y por eso se rompía el cálculo
        function calcularSubtotal(index) {
            const row = document.querySelectorAll('#detallesContainer tr')[index];
            if (!row) return;

            const select = row.querySelector('.producto-select');
            if (!select || !select.value) {
                row.querySelector('.subtotal-display').value = "";
                calcularTotal();
                return;
            }

            const isMayor = document.getElementById('switchVentaMayor').checked;
            const pNormal = parseFloat(select.options[select.selectedIndex].getAttribute('data-precio')) || 0;
            const pMayor = parseFloat(select.options[select.selectedIndex].getAttribute('data-preciomayor')) || pNormal;
            const precioAEjercer = isMayor ? pMayor : pNormal;

            const cantidadRaw = parseFloat(row.querySelector('.cantidad-input')?.value) || 0;

            // --- CAMBIO AQUÍ: Conversión basada en KGM o LTR ---
            const tipo = select.options[select.selectedIndex].getAttribute('data-tipo');
            const cantidadCalculo = (tipo === 'KGM' || tipo === 'LTR') ? (cantidadRaw / 1000) : cantidadRaw;
            // -------------------------------------------------------

            const subItem = cantidadCalculo * precioAEjercer;
            row.querySelector('.subtotal-display').value =
                subItem.toLocaleString('es-CO', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

            calcularTotal();
        }

        function eliminarDetalle(btn) {
            const totalFilas = document.querySelectorAll('#detallesContainer tr').length;
            if (totalFilas <= 1) {
                Swal.fire('Error', 'Debe haber al menos un producto en el pedido', 'error');
                return;
            }

            Swal.fire({
                title: '¿Eliminar producto?',
                text: 'Esta acción no se puede deshacer',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Sí, eliminar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    btn.closest('tr').remove();
                    calcularTotal();
                    reindexarDetalles(); // <--- Crucial
                }
            });
        }

        function actualizarPrecio(index) {
            const row = document.querySelectorAll('#detallesContainer tr')[index];
            if(!row) return;

            const select = row.querySelector('.producto-select');
            const isMayor = document.getElementById('switchVentaMayor').checked;

            if (!select.value) {
                row.querySelector('.precio-unitario-display').value = "";
                row.querySelector('.impuesto-display').value = "";
                row.querySelector('.subtotal-display').value = "";
                calcularTotal();
                return;
            }

            const pNormal = parseFloat(select.options[select.selectedIndex].getAttribute('data-precio')) || 0;
            const pMayor = parseFloat(select.options[select.selectedIndex].getAttribute('data-preciomayor')) || pNormal;
            const precioAEjercer = isMayor ? pMayor : pNormal;

            const impuesto = parseFloat(select.options[select.selectedIndex].getAttribute('data-impuesto')) || 0;

            // --- CAMBIO AQUÍ: Ahora comparamos con códigos DIAN ---
            const tipo = select.options[select.selectedIndex].getAttribute('data-tipo');
            const label = row.querySelector('.unidad-label');
            label.textContent = (tipo === 'KGM') ? "gr" : (tipo === 'LTR' ? "ml" : "un");
            // -------------------------------------------------------

            row.querySelector('.precio-unitario-display').value = precioAEjercer.toLocaleString('es-CO', {minimumFractionDigits: 2});
            row.querySelector('.impuesto-display').value = impuesto.toFixed(2) + '%';

            calcularSubtotal(index);
        }

        function calcularTotal() {
            let subtotalGeneral = 0;
            let impuestoGeneral = 0;
            const isMayor = document.getElementById('switchVentaMayor').checked;

            // 1. Calcular base de productos e impuestos
            document.querySelectorAll('.detalle-item').forEach(fila => {
                const select = fila.querySelector('.producto-select');
                if (!select || !select.value) return;

                const opt = select.options[select.selectedIndex];
                const pNormal = parseFloat(opt.getAttribute('data-precio')) || 0;
                const pMayor = parseFloat(opt.getAttribute('data-preciomayor')) || pNormal;
                const precioAEjercer = isMayor ? pMayor : pNormal;

                const cantidad = parseFloat(fila.querySelector('.cantidad-input').value) || 0;
                const tasaImpuesto = parseFloat(opt.getAttribute('data-impuesto')) || 0;

                const tipo = opt.getAttribute('data-tipo');
                let cantidadCalculo = (tipo === 'KGM' || tipo === 'LTR') ? cantidad / 1000 : cantidad;

                const subItem = cantidadCalculo * precioAEjercer;
                subtotalGeneral += subItem;
                impuestoGeneral += (subItem * tasaImpuesto) / 100;
            });

            // 2. Lógica de DESCUENTO
            const inputDesc = document.getElementById('inputDescuento');
            const porcDescuento = parseFloat(inputDesc.value) || 0;
            const valorDescuento = subtotalGeneral * (porcDescuento / 100);

            // 3. Flete
            const flete = parseFloat(document.querySelector('input[name="flete"]').value) || 0;

            // 4. TOTAL FINAL: (Subtotal - Descuento) + Impuestos + Flete
            const totalFinal = (subtotalGeneral - valorDescuento) + impuestoGeneral + flete;

            // 5. Actualizar etiquetas en la interfaz
            document.getElementById('totalSubtotalLabel').innerText = subtotalGeneral.toLocaleString('es-CO', {minimumFractionDigits: 2});
            document.getElementById('totalImpuestosLabel').innerText = impuestoGeneral.toLocaleString('es-CO', {minimumFractionDigits: 2});
            document.getElementById('valorDescuentoCalculado').innerText = valorDescuento.toLocaleString('es-CO', {minimumFractionDigits: 2});
            document.getElementById('totalPedidoLabel').innerText = totalFinal.toLocaleString('es-CO', {minimumFractionDigits: 2});
        }

        // Alias para evitar errores si el HTML llama a calcularTotales()
        function calcularTotales() {
            calcularTotal();
        }

        function alternarPreciosGlobal() {
            const isMayor = document.getElementById('switchVentaMayor').checked;
            const label = document.getElementById('labelVenta');

            label.innerText = isMayor ? "Precio MAYORISTA" : "Precio DETAL";
            label.className = isMayor ? "small font-weight-bold text-success" : "small font-weight-bold text-danger";

            // Forzar actualización de todas las filas
            document.querySelectorAll('#detallesContainer tr').forEach((fila, index) => {
                actualizarPrecio(index);
            });
        }
        $(document).ready(function () {
            calcularTotal();

            const s = /*[[${success}]]*/ null;
            const e = /*[[${error}]]*/ null;
            const i = /*[[${info}]]*/ null;
            checkNotifications(s, e, i, null);
        });
    </script>
</th:block>
</body>
</html>