<!DOCTYPE html>
<html lang="es"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/adminlte}">
<head>
    <title>Crear Pedido</title>
    <style>
        .cliente-card {
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 15px;
            background-color: #f9f9f9;
            transition: all 0.3s;
        }
        .cliente-card.encontrado {
            border: 2px solid #28a745;
            background-color: #d4edda;
        }
        .cliente-info { display: none; }
        .cliente-info.show { display: block; }

        .detalle-item {
            border-bottom: 1px solid #eee;
            transition: background 0.3s;
        }
        .detalle-item:hover { background-color: #fcfcfc; }

        .total-box {
            background-color: #f8f9fa;
            border-radius: 5px;
            padding: 15px;
            border: 1px solid #dee2e6;
        }
        .total-final {
            font-size: 1.5rem;
            color: #007bff;
            font-weight: bold;
        }
    </style>
</head>
<body>

<div layout:fragment="content">
    <section class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1><i class="fas fa-cart-plus mr-2"></i> Nuevo Pedido</h1>
                </div>
            </div>
        </div>
    </section>

    <section class="content">
        <div class="container-fluid">
            <form th:action="@{/pedidos/crear}" th:object="${pedido}" method="POST" id="formPedido">

                <div class="row">
                    <div class="col-md-8">
                        <div class="card card-primary card-outline shadow">
                            <div class="card-header">
                                <h3 class="card-title font-weight-bold">
                                    <i class="fas fa-user-search mr-1"></i> Información del Cliente
                                </h3>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="buscarNumeroId">Identificación <span class="text-danger">*</span></label>
                                            <div class="input-group">
                                                <input type="text" id="buscarNumeroId" class="form-control" placeholder="Cédula o NIT...">
                                                <div class="input-group-append">
                                                    <button type="button" class="btn btn-primary" onclick="buscarCliente()">
                                                        <i class="fas fa-search"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label for="fechaEntrega">Fecha de Entrega <span class="text-danger">*</span></label>
                                            <input type="datetime-local" id="fechaEntrega" th:field="*{fechaEntrega}" class="form-control" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="cliente-card" id="clienteCard">
                                            <div class="text-center text-muted" id="clienteNoSeleccionado">
                                                <i class="fas fa-user-slash fa-2x mb-2"></i>
                                                <p class="mb-0">Sin cliente seleccionado</p>
                                            </div>
                                            <div class="cliente-info" id="clienteInfo">
                                                <h5 class="text-success mb-2">
                                                    <i class="fas fa-check-circle mr-1"></i> Seleccionado
                                                </h5>
                                                <p class="mb-1"><strong>Nombre:</strong> <span id="clienteNombre"></span></p>
                                                <p class="mb-1"><strong>Email:</strong> <span id="clienteEmail"></span></p>
                                                <p class="mb-0"><strong>Tel:</strong> <span id="clienteTelefono"></span></p>
                                            </div>
                                        </div>
                                        <input type="hidden" name="cliente.id" id="clienteIdHidden">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card card-info shadow">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h3 class="card-title font-weight-bold">
                                    <i class="fas fa-boxes mr-1"></i> Ítems del Pedido
                                </h3>
                                <button type="button" class="btn btn-primary btn-sm ml-auto" onclick="agregarDetalle()">
                                    <i class="fas fa-plus mr-1"></i> Agregar Producto
                                </button>
                            </div>
                            <div class="card-body p-0">
                                <table class="table table-striped mb-0">
                                    <thead class="bg-light">
                                    <tr>
                                        <th style="width: 25%">Categoría</th>
                                        <th style="width: 25%">Producto</th>
                                        <th style="width: 10%">Cant.</th>
                                        <th style="width: 15%">P. Unit</th>
                                        <th style="width: 10%">IVA %</th>
                                        <th style="width: 15%">Subtotal</th>
                                        <th style="width: 40px"></th>
                                    </tr>
                                    </thead>
                                    <tbody id="detallesContainer">
                                    <tr class="detalle-item">
                                        <td>
                                            <select class="form-control categoria-filter" onchange="filtrarProductos(this)">
                                                <option value="">-- Todas --</option>
                                                <option th:each="cat : ${categoria}"
                                                        th:value="${cat.id}"
                                                        th:text="${cat.nombrecategoria}"></option>
                                            </select>
                                        </td>
                                        <td>
                                            <select name="detalles[0].producto.id" class="form-control producto-select" required onchange="actualizarPrecio(0)">
                                                <option value="" disabled selected>-- Seleccionar --</option>
                                                <option th:each="p : ${productos}"
                                                        th:value="${p.id}"
                                                        th:text="${p.nombre}"
                                                        th:data-categoria="${p.categoria.id}"
                                                        th:data-precio="${p.precio}"
                                                        th:data-impuesto="${p.impuesto}"
                                                        th:data-tipo="${p.tipoVenta.name()}"></option>
                                            </select>
                                        </td>
                                        <td>
                                            <input type="number" name="detalles[0].cantidad" class="form-control cantidad-input" min="0.01" value="1.00" step="0.01" required onchange="calcularSubtotal(0)">
                                        </td>
                                        <td>
                                            <input type="number" name="detalles[0].precioUnitario" class="form-control precio-unitario bg-light" step="0.01" readonly>
                                        </td>
                                        <td>
                                            <input type="number" name="detalles[0].impuestoProducto" class="form-control impuesto-producto bg-light" step="0.01" readonly>
                                        </td>
                                        <td>
                                            <input type="number" name="detalles[0].subtotal" class="form-control subtotal-item bg-light text-bold" step="0.01" readonly>
                                        </td>
                                        <td class="text-center"></td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="card card-secondary card-outline shadow">
                            <div class="card-header p-2">
                                <span class="ml-2 font-weight-bold text-muted">Observaciones</span>
                            </div>
                            <div class="card-body p-2">
                                <textarea th:field="*{observaciones}" class="form-control border-0" rows="2" placeholder="Notas adicionales..."></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="card shadow">
                            <div class="card-header bg-primary">
                                <h3 class="card-title font-weight-bold">Resumen Económico</h3>
                            </div>
                            <div class="card-body">
                                <div class="form-group d-flex justify-content-between">
                                    <span>Subtotal (Base):</span>
                                    <span class="font-weight-bold">$ <span id="totalSubtotalLabel">0.00</span></span>
                                    <input type="hidden" id="totalSubtotal">
                                </div>
                                <div class="form-group">
                                    <label for="flete">Flete / Envío (Opcional)</label>
                                    <input type="number" id="flete" th:field="*{flete}" class="form-control" step="0.01" min="0" onchange="calcularTotal()">
                                </div>
                                <div class="form-group d-flex justify-content-between">
                                    <label>Sumatoria IVA:</label>
                                    <span class="font-weight-bold">$ <span id="totalImpuestosLabel">0.00</span></span>
                                    <input type="hidden" id="impuesto" th:field="*{impuesto}">
                                </div>
                                <hr>
                                <div class="total-box text-center mb-4">
                                    <span class="d-block text-muted small text-uppercase">Total a Pagar</span>
                                    <span class="total-final">$ <span id="totalPedidoLabel">0.00</span></span>
                                    <input type="hidden" id="totalPedido" th:field="*{total}">
                                </div>

                                <button type="submit" class="btn btn-success btn-block btn-lg shadow">
                                    <i class="fas fa-save mr-1"></i> GUARDAR PEDIDO
                                </button>
                                <a th:href="@{/pedidos/listarpedidos}" class="btn btn-default btn-block mt-2">Cancelar</a>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </section>
</div>

<th:block layout:fragment="scripts">
    <script th:inline="javascript">
        const clientesData = /*[[${clientes}]]*/ [];
        let detalleCount = 1;

        // FILTRO DE CATEGORÍAS
        function filtrarProductos(selectCategoria) {
            const categoriaId = selectCategoria.value;
            const fila = selectCategoria.closest('tr');
            const selectProducto = fila.querySelector('.producto-select');
            const opciones = selectProducto.querySelectorAll('option');

            selectProducto.value = ""; // Resetear selección

            opciones.forEach(opt => {
                if (opt.value === "") return;
                const productoCatId = opt.getAttribute('data-categoria');
                if (categoriaId === "" || productoCatId === categoriaId) {
                    opt.style.display = "block";
                    opt.disabled = false;
                } else {
                    opt.style.display = "none";
                    opt.disabled = true;
                }
            });
            actualizarPrecio(fila.rowIndex - 1); // Forzar reset de precio/subtotal
        }

        // BÚSQUEDA DE CLIENTE
        function buscarCliente() {
            const numeroId = document.getElementById('buscarNumeroId').value.trim();
            if (!numeroId) {
                Swal.fire('Atención', 'Ingrese un número de identificación', 'warning');
                return;
            }
            const cliente = clientesData.find(c => c.numeroIdentificacion === numeroId);
            if (cliente) {
                document.getElementById('clienteIdHidden').value = cliente.id;
                document.getElementById('clienteNombre').textContent = cliente.nombre + ' ' + (cliente.apellido || '');
                document.getElementById('clienteEmail').textContent = cliente.email || 'N/A';
                document.getElementById('clienteTelefono').textContent = cliente.telefono || 'N/A';
                document.getElementById('clienteNoSeleccionado').style.display = 'none';
                document.getElementById('clienteInfo').classList.add('show');
                document.getElementById('clienteCard').classList.add('encontrado');
                Swal.fire({ icon: 'success', title: 'Cliente Encontrado', timer: 1000, showConfirmButton: false });
            } else {
                Swal.fire({
                    title: 'Cliente no encontrado',
                    text: '¿Desea registrarlo?',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'Sí, registrar'
                }).then((result) => {
                    if (result.isConfirmed) window.open('/crearcliente/nuevo', '_blank');
                });
            }
        }

        // AGREGAR FILA
        function agregarDetalle() {
            const container = document.getElementById('detallesContainer');
            const opcionesCat = document.querySelector('.categoria-filter').innerHTML;
            const opcionesProd = document.querySelector('.producto-select').innerHTML;

            const tr = document.createElement('tr');
            tr.className = 'detalle-item';
            tr.innerHTML = `
                <td>
                    <select class="form-control categoria-filter" onchange="filtrarProductos(this)">
                        ${opcionesCat}
                    </select>
                </td>
                <td>
                    <select name="detalles[${detalleCount}].producto.id" class="form-control producto-select" required onchange="actualizarPrecio(${detalleCount})">
                        ${opcionesProd}
                    </select>
                </td>
                <td>
                    <input type="number" name="detalles[${detalleCount}].cantidad" class="form-control cantidad-input" min="0.01" value="1.00" step="0.01" required onchange="calcularSubtotal(${detalleCount})">
                </td>
                <td>
                    <input type="number" name="detalles[${detalleCount}].precioUnitario" class="form-control precio-unitario bg-light" readonly step="0.01">
                </td>
                <td>
                    <input type="number" name="detalles[${detalleCount}].impuestoProducto" class="form-control impuesto-producto bg-light" readonly step="0.01">
                </td>
                <td>
                    <input type="number" name="detalles[${detalleCount}].subtotal" class="form-control subtotal-item bg-light text-bold" readonly step="0.01">
                </td>
                <td class="text-center">
                    <button type="button" class="btn btn-link text-danger" onclick="eliminarFila(this)"><i class="fas fa-trash-alt"></i></button>
                </td>
            `;
            container.appendChild(tr);
            detalleCount++;
        }

        function eliminarFila(btn) {
            btn.closest('tr').remove();
            calcularTotal();
        }

        function actualizarPrecio(index) {
            const row = document.querySelectorAll('#detallesContainer tr')[index];
            if(!row) return;
            const select = row.querySelector('.producto-select');

            if (!select.value) {
                row.querySelector('.precio-unitario').value = "";
                row.querySelector('.impuesto-producto').value = "";
                row.querySelector('.subtotal-item').value = "";
                calcularTotal();
                return;
            }

            const precio = select.options[select.selectedIndex].getAttribute('data-precio');
            const impuesto = select.options[select.selectedIndex].getAttribute('data-impuesto');

            row.querySelector('.precio-unitario').value = parseFloat(precio).toFixed(2);
            row.querySelector('.impuesto-producto').value = parseFloat(impuesto).toFixed(2);

            calcularSubtotal(index);
        }

        function calcularSubtotal(index) {
            const row = document.querySelectorAll('#detallesContainer tr')[index];
            if(!row) return;
            const select = row.querySelector('.producto-select');
            if (!select.value) return;

            const tipoVenta = select.options[select.selectedIndex].getAttribute('data-tipo');
            let cant = parseFloat(row.querySelector('.cantidad-input').value) || 0;
            const precio = parseFloat(row.querySelector('.precio-unitario').val) || parseFloat(row.querySelector('.precio-unitario').value) || 0;

            let cantCalculo = (tipoVenta === 'PESO') ? cant / 1000 : cant;
            const subtotal = cantCalculo * precio;

            row.querySelector('.subtotal-item').value = subtotal.toFixed(2);
            calcularTotal();
        }

        function calcularTotal() {
            let subtotalGral = 0;
            let impuestoGral = 0;

            document.querySelectorAll('.detalle-item').forEach(fila => {
                const subItem = parseFloat(fila.querySelector('.subtotal-item').value) || 0;
                const pctIVA = parseFloat(fila.querySelector('.impuesto-producto').value) || 0;

                subtotalGral += subItem;
                impuestoGral += (subItem * pctIVA) / 100;
            });

            const flete = parseFloat(document.getElementById('flete').value) || 0;
            const total = subtotalGral + impuestoGral + flete;

            document.getElementById('totalSubtotalLabel').innerText = subtotalGral.toFixed(2);
            document.getElementById('totalImpuestosLabel').innerText = impuestoGral.toFixed(2);
            document.getElementById('impuesto').value = impuestoGral.toFixed(2);
            document.getElementById('totalPedidoLabel').innerText = total.toFixed(2);
            document.getElementById('totalPedido').value = total.toFixed(2);
        }

        $(document).ready(function () {
            const s = /*[[${success}]]*/ null;
            const e = /*[[${error}]]*/ null;
            const i = /*[[${info}]]*/ null;
            checkNotifications(s, e, i, null);
        });
    </script>
</th:block>
</body>
</html>