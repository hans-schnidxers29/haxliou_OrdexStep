<!DOCTYPE html>
<html lang="es"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/adminlte}">
<head>
    <title>Crear Pedido</title>
    <style>
        .cliente-card {
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 12px;
            background-color: #f9f9f9;
            transition: all 0.3s;
        }
        .cliente-card.encontrado {
            border: 2px solid #28a745;
            background-color: #d4edda;
        }
        .cliente-info { display: none; }
        .cliente-info.show { display: block; }

        .sticky-resumen {
            position: -webkit-sticky;
            position: sticky;
            top: 20px;
            z-index: 1020;
        }

        .resumen-compacto .card-body {
            padding: 12px !important;
        }

        .resumen-compacto .form-group {
            margin-bottom: 8px !important;
        }

        .total-box-mini {
            background-color: #f8f9fa;
            border-radius: 5px;
            padding: 10px;
            border: 1px solid #dee2e6;
        }

        .total-final-mini {
            font-size: 1.3rem;
            color: #007bff;
            font-weight: bold;
        }

        .table td, .table th {
            padding: 0.6rem !important;
            vertical-align: middle !important;
            font-size: 0.9rem;
        }

        .form-control-sm {
            height: calc(1.8rem + 2px);
        }
    </style>
</head>
<body>

<div layout:fragment="content">
    <section class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1><i class="fas fa-cart-plus mr-2"></i> Nuevo Pedido</h1>
                </div>
            </div>
        </div>
    </section>

    <section class="content">
        <div class="container-fluid">
            <form th:action="@{/pedidos/crear}" th:object="${pedido}" method="POST" id="formPedido">
                <div class="row">
                    <div class="col-md-9">
                        <div class="card card-primary card-outline shadow mb-3">
                            <div class="card-header py-2">
                                <h3 class="card-title font-weight-bold"><i class="fas fa-user-search mr-1"></i> Cliente</h3>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-7">
                                        <div class="form-group mb-2">
                                            <label class="small">Identificación <span class="text-danger">*</span></label>
                                            <div class="input-group input-group-sm">
                                                <input type="text" id="buscarNumeroId" class="form-control" placeholder="Cédula o NIT...">
                                                <div class="input-group-append">
                                                    <button type="button" class="btn btn-primary" onclick="buscarCliente()">
                                                        <i class="fas fa-search"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="form-group mb-0">
                                            <label class="small">Fecha de Entrega <span class="text-danger">*</span></label>
                                            <input type="datetime-local" th:field="*{fechaEntrega}" class="form-control form-control-sm" required>
                                        </div>
                                    </div>
                                    <div class="col-md-5">
                                        <div class="cliente-card" id="clienteCard">
                                            <div class="text-center text-muted" id="clienteNoSeleccionado">
                                                <p class="mb-0 small">Busque un cliente para continuar</p>
                                            </div>
                                            <div class="cliente-info" id="clienteInfo">
                                                <p class="mb-0 font-weight-bold text-success small">Cliente Seleccionado:</p>
                                                <div id="clienteNombre" class="font-weight-bold"></div>
                                                <div id="clienteTelefono" class="small text-muted"></div>
                                                <div id="clienteEmail" class="small text-muted"></div>
                                            </div>
                                        </div>
                                        <input type="hidden" name="cliente.id" id="clienteIdHidden">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card card-info shadow">
                            <div class="card-header d-flex justify-content-between align-items-center py-2">
                                <h3 class="card-title font-weight-bold small"><i class="fas fa-boxes mr-1"></i> Ítems</h3>
                                <button type="button" class="btn btn-primary btn-xs ml-auto" onclick="agregarDetalle()">
                                    <i class="fas fa-plus"></i> Añadir
                                </button>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-sm table-striped mb-0">
                                        <thead class="bg-light">
                                        <tr>
                                            <th>Categoría</th>
                                            <th>Producto</th>
                                            <th style="width: 120px;">Cantidad</th>
                                            <th>P. Unit (Ref)</th>
                                            <th>IVA % (Ref)</th>
                                            <th>Subtotal (Ref)</th>
                                            <th style="width: 40px;"></th>
                                        </tr>
                                        </thead>
                                        <tbody id="detallesContainer">
                                        <tr class="detalle-item">
                                            <td>
                                                <select class="form-control form-control-sm categoria-filter" onchange="filtrarProductos(this)">
                                                    <option value="">-- Todas --</option>
                                                    <option th:each="cat : ${categorias}" th:value="${cat.id}" th:text="${cat.nombrecategoria}"></option>
                                                </select>
                                            </td>
                                            <td>
                                                <select name="detalles[0].producto.id" class="form-control form-control-sm producto-select" required onchange="actualizarPrecio(0)">
                                                    <option value="" disabled selected>-- Seleccionar --</option>
                                                    <option th:each="p : ${productos}"
                                                            th:value="${p.id}"
                                                            th:text="${p.nombre}"
                                                            th:data-categoria="${p.categoria.id}"
                                                            th:data-precio="${p.precio}"
                                                            th:data-preciomayor="${p.precioPorMayor}"
                                                            th:data-impuesto="${p.impuesto}"
                                                            th:data-tipo="${p.tipoVenta.name()}"></option>
                                                </select>
                                            </td>
                                            <td>
                                                <div class="input-group input-group-sm">
                                                    <input type="number"
                                                           name="detalles[0].cantidad"
                                                           class="form-control cantidad-input"
                                                           min="0.01"
                                                           value="1"
                                                           step="any"
                                                           required
                                                           onchange="calcularSubtotal(0)">
                                                    <div class="input-group-append">
                                                        <span class="input-group-text unidad-label p-1" style="font-size: 0.7rem;">un</span>
                                                    </div>
                                                </div>
                                            </td>
                                            <td><input type="text" class="form-control form-control-sm precio-unitario-display bg-light text-right" readonly tabindex="-1"></td>
                                            <td><input type="text" class="form-control form-control-sm impuesto-display bg-light text-right" readonly tabindex="-1"></td>
                                            <td><input type="text" class="form-control form-control-sm subtotal-display bg-light font-weight-bold text-right" readonly tabindex="-1"></td>
                                            <td></td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-3">
                        <div class="sticky-resumen">
                            <div class="card shadow resumen-compacto border-primary">
                                <div class="card-header bg-primary py-2 text-center">
                                    <h3 class="card-title float-none font-weight-bold" style="font-size: 0.9rem;">Resumen</h3>
                                </div>
                                <div class="card-body">
                                    <div class="form-group mb-3 text-center border-bottom pb-2">
                                        <label class="d-block small font-weight-bold text-primary mb-1">TIPO DE PRECIO</label>
                                        <div class="custom-control custom-switch custom-switch-off-danger custom-switch-on-success">
                                            <input type="checkbox" th:field="*{ventaPorMayor}" class="custom-control-input" id="switchVentaMayor" onchange="alternarPreciosGlobal()">
                                            <label class="custom-control-label" for="switchVentaMayor">
                                                <span id="labelVenta" class="small font-weight-bold">Precio Detal</span>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="d-flex justify-content-between mb-1">
                                        <span class="text-muted small">Subtotal:</span>
                                        <span class="small font-weight-bold">$ <span id="totalSubtotalLabel">0.00</span></span>
                                    </div>
                                    <div class="form-group mb-2">
                                        <label class="small mb-0">Costo Envío / Flete</label>
                                        <input type="number" th:field="*{flete}" class="form-control form-control-sm" step="0.01" min="0" onchange="calcularTotal()" placeholder="0.00">
                                    </div>
                                    <div class="d-flex justify-content-between mb-1">
                                        <span class="text-muted small">IVA Total:</span>
                                        <span class="small font-weight-bold">$ <span id="totalImpuestosLabel">0.00</span></span>
                                    </div>
                                    <hr class="my-2">
                                    <div class="total-box-mini text-center mb-3">
                                        <span class="d-block text-muted small text-uppercase" style="font-size: 0.65rem;">Total a Pagar</span>
                                        <span class="total-final-mini">$ <span id="totalPedidoLabel">0.00</span></span>
                                    </div>
                                    <div class="alert alert-warning alert-sm py-2 px-2 mb-2" style="font-size: 0.7rem;">
                                        <i class="fas fa-info-circle"></i> <strong>Nota:</strong> Los valores mostrados son referenciales. El sistema calculará automáticamente los totales finales al guardar.
                                    </div>

                                    <button type="submit" class="btn btn-success btn-block shadow-sm font-weight-bold">
                                        <i class="fas fa-save mr-1"></i> GUARDAR PEDIDO
                                    </button>
                                    <a th:href="@{/pedidos/listarpedidos}" class="btn btn-xs btn-outline-secondary btn-block mt-2">Cancelar</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </section>
</div>

<th:block layout:fragment="scripts">
    <script th:inline="javascript">
        const clientesData = /*[[${clientes}]]*/ [];
        let detalleCount = 1;

        function filtrarProductos(selectCategoria) {
            const categoriaId = selectCategoria.value;
            const fila = selectCategoria.closest('tr');
            const selectProducto = fila.querySelector('.producto-select');
            const opciones = selectProducto.querySelectorAll('option');
            selectProducto.value = "";
            opciones.forEach(opt => {
                if (opt.value === "") return;
                const productoCatId = opt.getAttribute('data-categoria');
                if (categoriaId === "" || productoCatId === categoriaId) {
                    opt.style.display = "block";
                    opt.disabled = false;
                } else {
                    opt.style.display = "none";
                    opt.disabled = true;
                }
            });
            actualizarPrecio(fila.rowIndex - 1);
        }

        function buscarCliente() {
            const numeroId = document.getElementById('buscarNumeroId').value.trim();
            if (!numeroId) {
                Swal.fire('Error', 'Ingrese identificación', 'error');
                return;
            }
            const cliente = clientesData.find(c => c.numeroIdentificacion === numeroId);
            if (cliente) {
                document.getElementById('clienteIdHidden').value = cliente.id;
                document.getElementById('clienteNombre').textContent = cliente.nombre + ' ' + (cliente.apellido || '');
                document.getElementById('clienteTelefono').textContent = "Tel: " + (cliente.telefono || 'N/A');
                document.getElementById('clienteEmail').textContent = cliente.email || 'N/A';
                document.getElementById('clienteNoSeleccionado').style.display = 'none';
                document.getElementById('clienteInfo').classList.add('show');
                document.getElementById('clienteCard').classList.add('encontrado');
                Swal.fire({ icon: 'success', title: 'Cliente Encontrado', timer: 1000, showConfirmButton: false });
            } else {
                Swal.fire({
                    title: 'No existe',
                    text: '¿Registrar nuevo cliente?',
                    icon: 'question',
                    showCancelButton: true
                }).then((r) => {
                    if (r.isConfirmed) window.open('/crearcliente/nuevo', '_blank');
                });
            }
        }

        function agregarDetalle() {
            const container = document.getElementById('detallesContainer');
            const opcionesCat = document.querySelector('.categoria-filter').innerHTML;
            const opcionesProd = document.querySelector('.producto-select').innerHTML;
            const tr = document.createElement('tr');
            tr.className = 'detalle-item';
            tr.innerHTML = `
                <td><select class="form-control form-control-sm categoria-filter" onchange="filtrarProductos(this)">${opcionesCat}</select></td>
                <td><select name="detalles[${detalleCount}].producto.id" class="form-control form-control-sm producto-select" required onchange="actualizarPrecio(${detalleCount})">${opcionesProd}</select></td>
                <td>
                    <div class="input-group input-group-sm">
                        <input type="number" name="detalles[${detalleCount}].cantidad" class="form-control cantidad-input" min="0.01" value="1" step="any" required onchange="calcularSubtotal(${detalleCount})">
                        <div class="input-group-append"><span class="input-group-text unidad-label p-1" style="font-size: 0.7rem;">un</span></div>
                    </div>
                </td>
                <td><input type="text" class="form-control form-control-sm bg-light text-right precio-unitario-display" readonly tabindex="-1"></td>
                <td><input type="text" class="form-control form-control-sm bg-light text-right impuesto-display" readonly tabindex="-1"></td>
                <td><input type="text" class="form-control form-control-sm bg-light font-weight-bold text-right subtotal-display" readonly tabindex="-1"></td>
                <td class="text-center"><button type="button" class="btn btn-link text-danger p-0" onclick="this.closest('tr').remove(); calcularTotal();"><i class="fas fa-trash"></i></button></td>
            `;
            container.appendChild(tr);
            detalleCount++;
        }

        function actualizarPrecio(index) {
            const row = document.querySelectorAll('#detallesContainer tr')[index];
            if(!row) return;

            const select = row.querySelector('.producto-select');
            const isMayor = document.getElementById('switchVentaMayor').checked; // Leer el switch

            if (!select.value) {
                row.querySelector('.precio-unitario-display').value = "";
                row.querySelector('.impuesto-display').value = "";
                row.querySelector('.subtotal-display').value = "";
                calcularTotal();
                return;
            }

            // Lógica de selección de precio
            const precioNormal = parseFloat(select.options[select.selectedIndex].getAttribute('data-precio')) || 0;
            const precioMayor = parseFloat(select.options[select.selectedIndex].getAttribute('data-preciomayor')) || precioNormal;

            const precioAEjercer = isMayor ? precioMayor : precioNormal;

            const impuesto = parseFloat(select.options[select.selectedIndex].getAttribute('data-impuesto')) || 0;
            const tipo = select.options[select.selectedIndex].getAttribute('data-tipo');

            const label = row.querySelector('.unidad-label');
            label.textContent = (tipo === 'PESO') ? "gr" : (tipo === 'LIQUIDO' ? "ml" : "un");

            row.querySelector('.precio-unitario-display').value = precioAEjercer.toLocaleString('es-CO', {minimumFractionDigits: 2});
            row.querySelector('.impuesto-display').value = impuesto.toFixed(2) + '%';

            calcularSubtotal(index);
        }

        function calcularSubtotal(index) {
            const row = document.querySelectorAll('#detallesContainer tr')[index];
            if (!row) return;
            const select = row.querySelector('.producto-select');
            if (!select || !select.value) return;
            // 1. Detectar el estado del switch
            const isMayor = document.getElementById('switchVentaMayor').checked;
            // 2. Obtener ambos precios
            const precioNormal = parseFloat(select.options[select.selectedIndex].getAttribute('data-precio')) || 0;
            const precioMayor = parseFloat(select.options[select.selectedIndex].getAttribute('data-preciomayor')) || precioNormal;
            // 3. Elegir el precio según el switch
            const precioAEjercer = isMayor ? precioMayor : precioNormal;
            const tipo = select.options[select.selectedIndex].getAttribute('data-tipo');
            const cantidadOriginal = parseFloat(row.querySelector('input[name*="cantidad"]').value) || 0;
            // 4. Lógica de conversión para PESO (gr a kg)
            let cantidadParaCalculo = cantidadOriginal;
            if (tipo === 'PESO') {
                cantidadParaCalculo = cantidadOriginal / 1000;
            }
            // 5. Calcular y mostrar el subtotal de la fila
            const subtotalVista = cantidadParaCalculo * precioAEjercer;
            row.querySelector('.subtotal-display').value = subtotalVista.toLocaleString('es-CO', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });

            calcularTotal();
        }

        function calcularTotal() {
            let subtotalVista = 0;
            let impuestoVista = 0;
            const isMayor = document.getElementById('switchVentaMayor').checked;

            document.querySelectorAll('.detalle-item').forEach(fila => {
                const select = fila.querySelector('.producto-select');
                if (!select || !select.value) return;
                // Lógica de precio igual a la de la fila
                const pNormal = parseFloat(select.options[select.selectedIndex].getAttribute('data-precio')) || 0;
                const pMayor = parseFloat(select.options[select.selectedIndex].getAttribute('data-preciomayor')) || pNormal;
                const precioAEjercer = isMayor ? pMayor : pNormal;
                const tipo = select.options[select.selectedIndex].getAttribute('data-tipo');
                const cantidad = parseFloat(fila.querySelector('input[name*="cantidad"]').value) || 0;
                const tasaImpuesto = parseFloat(select.options[select.selectedIndex].getAttribute('data-impuesto')) || 0;
                let cantidadCalculo = (tipo === 'PESO') ? cantidad / 1000 : cantidad;
                const subItem = cantidadCalculo * precioAEjercer;
                subtotalVista += subItem;
                impuestoVista += (subItem * tasaImpuesto) / 100;
            });

            const flete = parseFloat(document.querySelector('input[name="flete"]').value) || 0;
            const totalVista = subtotalVista + impuestoVista + flete;

            document.getElementById('totalSubtotalLabel').innerText = subtotalVista.toLocaleString('es-CO', {minimumFractionDigits: 2});
            document.getElementById('totalImpuestosLabel').innerText = impuestoVista.toLocaleString('es-CO', {minimumFractionDigits: 2});
            document.getElementById('totalPedidoLabel').innerText = totalVista.toLocaleString('es-CO', {minimumFractionDigits: 2});
        }

        function alternarPreciosGlobal() {
            const isMayor = document.getElementById('switchVentaMayor').checked;
            const label = document.getElementById('labelVenta');

            label.innerText = isMayor ? "Precio MAYORISTA" : "Precio DETAL";
            label.className = isMayor ? "small font-weight-bold text-success" : "small font-weight-bold text-danger";

            // Recalcula todas las filas de la tabla
            document.querySelectorAll('#detallesContainer tr').forEach((fila, index) => {
                actualizarPrecio(index);
            });
        }

        $(document).ready(function () {
            const s = /*[[${success}]]*/ null;
            const e = /*[[${error}]]*/ null;
            const i = /*[[${info}]]*/ null;
            checkNotifications(s, e, i, null);
        });
    </script>
</th:block>
</body>
</html>