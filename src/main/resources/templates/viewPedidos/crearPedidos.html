<!DOCTYPE html>
<html lang="es"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/adminlte}">
<head>
    <title>Crear Pedido</title>
    <style>
        .detalle-item {
            border-bottom: 1px solid #eee;
            padding: 15px 0;
            transition: background 0.3s;
        }
        .detalle-item:hover { background-color: #fcfcfc; }
        .total-box {
            background-color: #f8f9fa;
            border-radius: 5px;
            padding: 15px;
            border: 1px solid #dee2e6;
        }
        .total-final {
            font-size: 1.5rem;
            color: #007bff;
            font-weight: bold;
        }
    </style>
</head>
<body>

<div layout:fragment="content">
    <section class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1><i class="fas fa-cart-plus mr-2"></i> Nuevo Pedido</h1>
                </div>
            </div>
        </div>
    </section>

    <section class="content">
        <div class="container-fluid">
            <form th:action="@{/pedidos/crear}" th:object="${pedido}" method="POST">

                <div class="row">
                    <div class="col-md-8">
                        <div class="card card-primary card-outline shadow">
                            <div class="card-header">
                                <h3 class="card-title font-weight-bold">
                                    <i class="fas fa-user-tag mr-1"></i> Información del Cliente
                                </h3>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-7">
                                        <div class="form-group">
                                            <label for="cliente">Cliente <span class="text-danger">*</span></label>
                                            <select id="cliente" th:field="*{cliente}" class="form-control select2" required>
                                                <option value="" disabled selected>-- Buscar cliente --</option>
                                                <option th:each="c : ${clientes}" th:value="${c.id}" th:text="${c.nombre}"></option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-5">
                                        <div class="form-group">
                                            <label for="fechaEntrega">Fecha de Entrega <span class="text-danger">*</span></label>
                                            <input type="datetime-local" id="fechaEntrega" th:field="*{fechaEntrega}" class="form-control" required>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card card-info shadow">
                            <div class="card-header">
                                <h3 class="card-title font-weight-bold">
                                    <i class="fas fa-boxes mr-1"></i> Ítems del Pedido
                                </h3>
                            </div>
                            <div class="card-body p-0">
                                <div id="detallesContainer" class="px-3">
                                    <div class="detalle-item">
                                        <div class="row align-items-end">
                                            <div class="col-md-5">
                                                <div class="form-group mb-0">
                                                    <label class="small">Producto</label>
                                                    <select name="detalles[0].producto.id" class="form-control producto-select" required onchange="actualizarPrecio(0)">
                                                        <option value="" disabled selected>-- Seleccionar --</option>
                                                        <option th:each="p : ${productos}"
                                                                th:value="${p.id}"
                                                                th:text="${p.nombre}"
                                                                th:data-precio="${p.precio}"></option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="form-group mb-0">
                                                    <label class="small">Cant.</label>
                                                    <input type="number" name="detalles[0].cantidad" class="form-control cantidad-input" min="1" value="1" required onchange="calcularSubtotal(0)">
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="form-group mb-0">
                                                    <label class="small">P. Unit</label>
                                                    <input type="number" name="detalles[0].precioUnitario" class="form-control precio-unitario bg-light" step="0.01" readonly>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="form-group mb-0">
                                                    <label class="small">Subtotal</label>
                                                    <div class="input-group">
                                                        <input type="number" name="detalles[0].subtotal" class="form-control subtotal-item bg-light text-bold" step="0.01" readonly>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="p-3">
                                    <button type="button" class="btn btn-outline-info btn-sm" onclick="agregarDetalle()">
                                        <i class="fas fa-plus mr-1"></i> Agregar otro producto
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="card card-secondary card-outline shadow">
                            <div class="card-header p-2">
                                <span class="ml-2 font-weight-bold text-muted">Observaciones</span>
                            </div>
                            <div class="card-body p-2">
                                <textarea th:field="*{observaciones}" class="form-control border-0" rows="2" placeholder="Notas adicionales..."></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="card shadow">
                            <div class="card-header bg-dark">
                                <h3 class="card-title font-weight-bold">Resumen Económico</h3>
                            </div>
                            <div class="card-body">
                                <div class="form-group d-flex justify-content-between">
                                    <span>Subtotal:</span>
                                    <span class="font-weight-bold">$ <span id="totalSubtotalLabel">0.00</span></span>
                                    <input type="hidden" id="totalSubtotal" step="0.001">
                                </div>
                                <div class="form-group">
                                    <label for="impuesto">Impuesto (%)</label>
                                    <input type="number" id="impuesto" th:field="*{impuesto}" class="form-control form-control-sm" step="0.001" onchange="calcularTotal()">
                                </div>
                                <hr>
                                <div class="total-box text-center mb-4">
                                    <span class="d-block text-muted small text-uppercase">Total a Pagar</span>
                                    <span class="total-final">$ <span id="totalPedidoLabel">0.000</span></span>
                                    <input type="hidden" id="totalPedido" th:field="*{total}">
                                </div>

                                <button type="submit" class="btn btn-success btn-block btn-lg shadow">
                                    <i class="fas fa-save mr-1"></i> GUARDAR PEDIDO
                                </button>
                                <a th:href="@{/pedidos/listarpedidos}" class="btn btn-default btn-block mt-2">
                                    Cancelar
                                </a>
                            </div>
                        </div>

                        <div class="info-box bg-light shadow-sm">
                            <span class="info-box-icon bg-info"><i class="fas fa-user-plus"></i></span>
                            <div class="info-box-content">
                                <span class="info-box-text">¿Cliente nuevo?</span>
                                <a th:href="@{/crearcliente/nuevo}" class="font-weight-bold text-info">Registrar Cliente</a>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </section>
</div>

<th:block layout:fragment="scripts">
    <script th:inline="javascript">
        let detalleCount = 1;

        function agregarDetalle() {
            const container = document.getElementById('detallesContainer');
            const nuevoDetalle = document.createElement('div');
            nuevoDetalle.className = 'detalle-item';

            const primerSelect = document.querySelector('.producto-select');
            const opciones = primerSelect.innerHTML;

            nuevoDetalle.innerHTML = `
                <div class="row align-items-end">
                    <div class="col-md-5">
                        <div class="form-group mb-0">
                            <select name="detalles[${detalleCount}].producto.id" class="form-control producto-select" required onchange="actualizarPrecio(${detalleCount})">
                                ${opciones}
                            </select>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group mb-0">
                            <input type="number" name="detalles[${detalleCount}].cantidad" class="form-control cantidad-input" min="1" value="1" required onchange="calcularSubtotal(${detalleCount})">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group mb-0">
                            <input type="number" name="detalles[${detalleCount}].precioUnitario" class="form-control precio-unitario bg-light" readonly>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="input-group mb-0">
                            <input type="number" name="detalles[${detalleCount}].subtotal" class="form-control subtotal-item bg-light text-bold" readonly>
                            <div class="input-group-append">
                                <button type="button" class="btn btn-danger" onclick="eliminarDetalle(this)">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(nuevoDetalle);
            detalleCount++;
        }

        function eliminarDetalle(boton) {
            boton.closest('.detalle-item').remove();
            calcularTotal();
        }

        function actualizarPrecio(index) {
            const select = document.querySelector(`select[name="detalles[${index}].producto.id"]`);
            const precio = select.options[select.selectedIndex].getAttribute('data-precio');
            const precioInput = document.querySelector(`input[name="detalles[${index}].precioUnitario"]`);
            precioInput.value = precio || 0;
            calcularSubtotal(index);
        }

        function calcularSubtotal(index) {
            const cantidad = document.querySelector(`input[name="detalles[${index}].cantidad"]`).value;
            const precio = document.querySelector(`input[name="detalles[${index}].precioUnitario"]`).value;
            const subtotal = (parseFloat(cantidad) || 0) * (parseFloat(precio) || 0);
            document.querySelector(`input[name="detalles[${index}].subtotal"]`).value = subtotal.toFixed(2);
            calcularTotal();
        }

        function calcularTotal() {
            let totalSubtotal = 0;
            document.querySelectorAll('.subtotal-item').forEach(item => {
                totalSubtotal += parseFloat(item.value) || 0;
            });

            const impuestoPorcentaje = parseFloat(document.getElementById('impuesto').value) || 0;
            const total = totalSubtotal + (totalSubtotal * (impuestoPorcentaje / 100));

            // Actualizar etiquetas visuales y campos ocultos
            document.getElementById('totalSubtotalLabel').innerText = totalSubtotal.toLocaleString('en-US', {minimumFractionDigits: 2});
            document.getElementById('totalSubtotal').value = totalSubtotal.toFixed(2);

            document.getElementById('totalPedidoLabel').innerText = total.toLocaleString('en-US', {minimumFractionDigits: 2});
            document.getElementById('totalPedido').value = total.toFixed(2);
        }
        $(document).ready(function () {
            // 1. Capturamos las variables de Spring/Thymeleaf para Toasts
            const s = /*[[${success}]]*/ null;
            const e = /*[[${error}]]*/ null;
            const i = /*[[${info}]]*/ null;
            const w = /*[[${warning}]]*/ null;
            checkNotifications(s, e, i, w);
        })
    </script>
</th:block>
</body>
</html>