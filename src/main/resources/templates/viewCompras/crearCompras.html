<!DOCTYPE html>
<html lang="es"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/adminlte}">

<head>
    <title>Crear Compra</title>
</head>

<body>

<section layout:fragment="content">

    <!-- HEADER -->
    <section class="content-header">
        <div class="container-fluid">
            <h1>
                <i class="fas fa-shopping-cart mr-2"></i>
                Nueva Compra
            </h1>
        </div>
    </section>

    <!-- FORMULARIO -->
    <section class="content">
        <div class="container-fluid">

            <div class="card card-outline card-primary shadow">

                <form th:action="@{/crear/compra}"
                      th:object="${compras}"
                      method="post">

                    <div class="card-body">

                        <!-- Información general de la compra -->
                        <div class="form-row">

                            <div class="form-group col-md-6">
                                <label>Proveedor</label>
                                <select th:field="*{proveedor.id}" class="form-control" required>
                                    <option value="" disabled selected>Seleccione un proveedor</option>
                                    <option th:each="prov : ${proveedores}" th:value="${prov.id}" th:text="${prov.nombre}"></option>
                                </select>
                            </div>

                            <div class="form-group col-md-6">
                                <label>Impuesto</label>
                                <input type="number" step="0.01" th:field="*{impuesto}" class="form-control" placeholder="Ej: 19.00">
                            </div>

                        </div>

                        <!-- Detalles de la compra -->
                        <div class="card card-outline card-secondary mt-3">
                            <h5>Detalle de Productos</h5>
                            <table class="table table-bordered" id="detalleTable">
                                <thead>
                                <tr>
                                    <th>Producto</th>
                                    <th>Cantidad/Kg</th>
                                    <th>Precio Unitario</th>
                                    <th>Subtotal</th>
                                    <th>Acciones</th>
                                </tr>
                                </thead>
                                <tbody>
                                <!-- Filas se agregan dinámicamente -->
                                </tbody>
                            </table>

                            <button type="button" class="btn btn-success btn-sm" id="agregarFila">
                                <i class="fas fa-plus"></i> Agregar Producto
                            </button>

                        </div>

                    </div>

                    <div class="card-footer text-right mt-2">
                        <a th:href="@{/listar}" class="btn btn-secondary">
                            Cancelar
                        </a>

                        <button type="submit" class="btn btn-primary">
                            Guardar Compra
                        </button>
                    </div>

                </form>
            </div>

        </div>
    </section>

</section>

<th:block layout:fragment="scripts">
<script th:inline="javascript">
    /*<![CDATA[*/
    let productos = /*[[${productos}]]*/ [];
    let contador = 0;

    function agregarFila() {
        let tbody = document.querySelector('#detalleTable tbody');
        let fila = document.createElement('tr');

        fila.innerHTML = `
            <td>
                <select name="detalles[${contador}].productos.id" class="form-control" required>
                    <option value="">--Seleccione--</option>
                    ${productos.map(p => `<option value="${p.id}">${p.nombre}</option>`).join('')}
                </select>
            </td>
            <td>
                <input type="number" name="detalles[${contador}].cantidad" class="form-control cantidad" min="0" step="0.01" required>
            </td>
            <td>
                <input type="number" name="detalles[${contador}].precioUnitario" class="form-control precio" min="0" step="0.01" required>
            </td>
            <td>
                <input type="text" name="detalles[${contador}].subtotal" class="form-control subtotal" readonly>
            </td>
            <td>
                <button type="button" class="btn btn-danger btn-sm eliminarFila"><i class="fas fa-trash"></i></button>
            </td>
        `;

        tbody.appendChild(fila);

        // Actualizar subtotal al cambiar cantidad o precio
        fila.querySelector('.cantidad').addEventListener('input', actualizarSubtotal);
        fila.querySelector('.precio').addEventListener('input', actualizarSubtotal);

        // Botón eliminar fila
        fila.querySelector('.eliminarFila').addEventListener('click', () => fila.remove());

        contador++;
    }

    function actualizarSubtotal(e) {
        let fila = e.target.closest('tr');
        let cantidad = parseFloat(fila.querySelector('.cantidad').value || 0);
        let precio = parseFloat(fila.querySelector('.precio').value || 0);
        fila.querySelector('.subtotal').value = (cantidad * precio).toFixed(2);
    }

    document.querySelector('#agregarFila').addEventListener('click', agregarFila);
    /*]]>*/
</script>
</th:block>


</body>
</html>
