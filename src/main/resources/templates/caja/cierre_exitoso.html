<!DOCTYPE html>
<html lang="es"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/adminlte}"> <head>
  <title>Procesando Cierre</title>
</head>

<body>
<div layout:fragment="content">
  <div class="container text-center" style="padding-top: 100px; min-height: 400px;">
    <div class="card shadow-lg p-5">
      <div class="spinner-border text-danger" style="width: 3rem; height: 3rem;" role="status">
        <span class="sr-only">Cargando...</span>
      </div>
      <h3 class="mt-4">Finalizando Operación de Caja</h3>
      <p class="text-muted">Guardando datos y generando ticket. Por favor espere...</p>

      <div id="manualBtn" style="display:none;" class="mt-3">
        <p class="text-warning">Si el ticket no se abrió, haz clic abajo:</p>
        <a id="linkTicket" href="#" target="_blank" class="btn btn-danger">Abrir Ticket Manualmente</a>
      </div>
    </div>
  </div>

  <script th:inline="javascript">
    // 1. Datos del modelo
    const cajaId = [[${cajaId}]];

    // La URL ahora es limpia, sin parámetros extras
    const urlReporte = /*[[ @{/caja/reporte-cierre-final/} ]]*/ '/reporte-cierre-final/';
    const urlFinal = urlReporte + cajaId;
    const urlRetorno = /*[[ @{/ventas/crear} ]]*/ '/ventas/crear';

    // 3. Ejecución inmediata al cargar
    document.addEventListener("DOMContentLoaded", function() {
      const win = window.open(urlFinal, '_blank');

      if (!win) {
        // Si el navegador bloqueó el popup
        document.getElementById('manualBtn').style.display = 'block';
        document.getElementById('linkTicket').href = urlFinal;
      } else {
        // Si funcionó, redirigimos la ventana actual
        setTimeout(() => {
          window.location.href = urlRetorno;
        }, 2000);
      }
    });
  </script>
</div>
</body>
</html>