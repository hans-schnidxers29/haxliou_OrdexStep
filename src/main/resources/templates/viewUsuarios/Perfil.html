<!DOCTYPE html>
<html lang="es"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/adminlte}">
<head>
    <meta charset="UTF-8">
    <title>Gestión de Usuarios</title>

    <th:block layout:fragment="css">
        <style>
            .table-v-align td { vertical-align: middle !important; }
            .profile-user-img {
                border: 3px solid #007bff;
                width: 100px;
                height: 100px;
                object-fit: cover;
                font-size: 2rem;
                display: flex;
                align-items: center;
                justify-content: center;
                background-color: #007bff;
                color: white;
                margin: 0 auto;
            }
            .content { padding-left: 0 !important; }
        </style>
    </th:block>
</head>

<body>

<div layout:fragment="content">

    <section class="content-header">
        <div class="container-fluid">
            <div class="row mb-3 align-items-center">
                <div class="col-sm-6">
                    <h1 class="m-0">
                        <i class="fas fa-users-cog text-primary mr-2"></i> Gestión de Usuarios
                    </h1>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a th:href="@{/Home}">Inicio</a></li>
                        <li class="breadcrumb-item active">Usuarios</li>
                    </ol>
                </div>
            </div>
        </div>
    </section>

    <section class="content">
        <div class="container-fluid">
            <div class="row">

                <div class="col-md-4">
                    <div class="card card-primary card-outline shadow-sm">
                        <div class="card-body box-profile">
                            <div class="text-center mb-3">
                                <div class="profile-user-img img-circle shadow-sm">
                                    <span th:text="${#strings.substring(#authentication.name,0,2).toUpperCase()}">US</span>
                                </div>
                            </div>
                            <h3 class="profile-username text-center font-weight-bold" th:text="${#authentication.name}">Usuario</h3>
                            <p class="text-muted text-center small">
                                <span sec:authentication="principal.authorities">ROL</span>
                            </p>

                            <ul class="list-group list-group-unbordered mb-3">
                                <li class="list-group-item">
                                    <b>ID Usuario</b>
                                    <a class="float-right text-primary" th:text="${#authentication.name}">email@dominio.com</a>
                                </li>
                                <li class="list-group-item border-bottom-0">
                                    <b>Estado</b>
                                    <a class="float-right"><span class="badge badge-success">Activo</span></a>
                                </li>
                            </ul>
                            <form th:action="@{/logout}" method="post">
                                <button type="submit" class="btn btn-outline-danger btn-block shadow-sm">
                                    <i class="fas fa-sign-out-alt mr-1"></i> Cerrar Sesión
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="col-md-8" sec:authorize="hasRole('ADMIN')">
                    <div class="card shadow-sm">
                        <div class="card-header border-0 bg-white">
                            <h3 class="card-title font-weight-bold">Lista de Miembros</h3>
                            <div class="card-tools">
                                <a th:href="@{/registro/usuario}" class="btn btn-primary btn-sm shadow-sm">
                                    <i class="fas fa-plus mr-1"></i> Nuevo Usuario
                                </a>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover table-v-align m-0">
                                    <thead class="bg-light">
                                    <tr>
                                        <th style="width: 35%">Información</th>
                                        <th>Email</th>
                                        <th>Rol</th>
                                        <th class="text-center">Acciones</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <tr th:each="usuario : ${usuarios}">
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-user-circle fa-2x text-secondary mr-3"></i>
                                                <div>
                                                    <div class="font-weight-bold" th:text="${usuario.nombre + ' ' + usuario.apellido}">Nombre</div>
                                                    <small class="text-muted" th:text="'ID: ' + ${usuario.id}">ID: 1</small>
                                                </div>
                                            </div>
                                        </td>
                                        <td th:text="${usuario.email}">email@ejemplo.com</td>
                                        <td>
                                            <th:block th:each="rol : ${usuario.roles}">
                                                <span th:if="${rol.nombre == 'ROLE_ADMIN'}" class="badge badge-danger shadow-sm mr-1">
                                                    <i class="fas fa-crown mr-1"></i>ADMIN
                                                </span>
                                                <span th:if="${rol.nombre == 'ROLE_USER'}" class="badge badge-info shadow-sm">
                                                    <i class="fas fa-user-tag mr-1"></i>VENDEDOR
                                                </span>
                                            </th:block>
                                        </td>
                                        <td class="text-center">
                                            <div class="btn-group">
                                                <a th:href="@{/registro/editar/usuario/{id}(id=${usuario.id})}"
                                                   class="btn btn-default btn-sm border shadow-sm mx-1"
                                                   title="Editar">
                                                    <i class="fas fa-edit text-primary"></i>
                                                </a>

                                                <a th:href="@{/registro/{id}(id=${usuario.id})}"
                                                   class="btn btn-default btn-sm border shadow-sm mx-1 btn-confirmar"
                                                   title="Eliminar">
                                                    <i class="fas fa-trash-alt text-danger"></i>
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="card-footer bg-white text-right">
                            <small class="text-muted italic">Total de usuarios: <span th:text="${#lists.size(usuarios)}">0</span></small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>

<!-- Scripts específicos de esta página -->
<th:block layout:fragment="scripts">
    <script th:inline="javascript">
        $(document).ready(function() {
            // 1. Capturamos las variables de Spring/Thymeleaf para Toasts
            const s = /*[[${success}]]*/ null;
            const e = /*[[${error}]]*/ null;
            const i = /*[[${info}]]*/ null;
            const w = /*[[${warning}]]*/ null;

            // Ejecutamos la función de notificaciones automáticas
            checkNotifications(s, e, i, w);

            // 2. Lógica para la Confirmación de Eliminación
            // Buscamos cualquier botón que tenga el ID o URL de eliminación
            $('.btn-eliminar-confirm').on('click', function(event) {
                event.preventDefault(); // Detenemos la navegación inmediata

                const url = $(this).attr('href'); // Extraemos la URL del enlace

                // Llamamos a la función confirmarEliminarUrl de tu notifications.js
                // Argumentos: (id, url, titulo, texto)
                confirmarEliminar(null, url, '¿Eliminar Usuario?', 'Esta acción no se puede deshacer');
            });
        });
    </script>
</th:block>
</body>
</html>