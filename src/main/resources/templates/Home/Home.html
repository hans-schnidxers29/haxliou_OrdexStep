<!DOCTYPE html>
<html lang="es"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layouts/adminlte}">

<head>
    <title>Dashboard - Gestor de Pedidos</title>
    <style>
        .small-box { transition: transform .3s; border-radius: 15px; overflow: hidden; }
        .small-box:hover { transform: translateY(-5px); box-shadow: 0 1rem 3rem rgba(0,0,0,.175)!important; }
        .small-box .icon { top: 10px; right: 15px; font-size: 60px; color: rgba(0,0,0,0.15); }
        .card-custom { border-radius: 15px; border: none; height: 100%; }
        .chart-container { position: relative; height: 300px; width: 100%; }
        /* Ajuste para que la tabla se vea bien en el contenedor del gráfico */
        .table-responsive-custom { max-height: 300px; overflow-y: auto; }
    </style>
</head>

<body>
<div layout:fragment="content">

    <div class="content-header">
        <div class="container-fluid">
            <div class="row mb-2 align-items-center">

                <!-- Título a la IZQUIERDA -->
                <div class="col-sm-6 d-flex align-items-center">
                    <h1 class="m-0 font-weight-bold text-dark">
                        <i class="fas fa-tachometer-alt mr-2 text-primary"></i>
                        Panel de Gestión
                    </h1>
                </div>

                <!-- Anuncio a la DERECHA -->
                <div class="col-sm-6 d-flex justify-content-end align-items-center">
                    <div id="banner-vencimiento"
                         class="hidden d-inline-flex align-items-center px-3 py-2 shadow-sm"
                         style="background-color: #1a222b; border-radius: 8px; border-left: 4px solid #f39c12;">

                        <span id="mensaje-alerta"
                              class="font-weight-bold"
                              style="color: #f39c12; font-size: 0.85rem; letter-spacing: 0.5px;">
                        </span>

                        <button class="btn btn-xs ml-3 font-weight-bold px-3"
                                style="background-color: #f39c12; color: #1a222b; border-radius: 4px; border: none;">
                            RENOVAR
                        </button>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <section class="content">
        <div class="container-fluid">

            <div class="row">
                <div class="col-lg-3 col-6">
                    <div class="small-box bg-gradient-warning elevation-2">
                        <div class="inner">
                            <h3 th:text="${totalPedidosPendientes ?: 0}">0</h3>
                            <p>Pedidos por Despachar</p>
                        </div>
                        <div class="icon"><i class="fas fa-shipping-fast"></i></div>
                        <a th:href="@{/pedidos/listarpedidos}" class="small-box-footer">Ver Pedidos <i class="fas fa-arrow-circle-right"></i></a>
                    </div>
                </div>

                <div class="col-lg-3 col-6">
                    <div class="small-box bg-gradient-primary elevation-2">
                        <div class="inner">
                            <h3 th:text="${totalClientes ?: 0}">0</h3>
                            <p>Clientes Registrados</p>
                        </div>
                        <div class="icon"><i class="fas fa-users"></i></div>
                        <a th:href="@{/listarclientes}" class="small-box-footer">Directorio <i class="fas fa-arrow-circle-right"></i></a>
                    </div>
                </div>

                <div class="col-lg-3 col-6">
                    <div class="small-box bg-gradient-success elevation-2">
                        <div class="inner">
                            <h3>$<span th:text="${#numbers.formatDecimal(recaudacionMes, 1, 'COMMA', 2, 'POINT')}">0</span></h3>
                            <p>Ventas del Mes</p>
                        </div>
                        <div class="icon"><i class="fas fa-dollar-sign"></i></div>
                        <a th:href="@{/ventas/listar}" class="small-box-footer">Ir a Ventas <i class="fas fa-arrow-circle-right"></i></a>
                    </div>
                </div>

                <div class="col-lg-3 col-6">
                    <div class="small-box bg-gradient-danger elevation-2">
                        <div class="inner">
                            <h3 th:text="${totalProductosBajoStock}">0</h3>
                            <p>Stock Crítico</p>
                        </div>
                        <div class="icon"><i class="fas fa-exclamation-triangle"></i></div>
                        <a th:href="@{/listarproductos}" class="small-box-footer">Revisar Stock <i class="fas fa-arrow-circle-right"></i></a>
                    </div>
                </div>
            </div>

            <div class="row mt-4">

                <div class="col-md-8">
                    <div class="card card-custom card-outline card-danger shadow-sm">
                        <div class="card-header bg-white">
                            <h3 class="card-title font-weight-bold text-danger">
                                <i class="fas fa-box-open mr-1"></i> Alertas de Reposición (Stock Crítico)
                            </h3>
                            <div class="card-tools">
                                <a th:href="@{/listarproductos}" class="btn btn-tool text-danger">Ver todo</a>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive table-responsive-custom">
                                <table class="table table-hover table-valign-middle m-0">
                                    <thead class="bg-light">
                                    <tr>
                                        <th>Producto</th>
                                        <th>Stock</th>
                                        <th>Estado</th>
                                        <th class="text-center">Acción</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <tr th:each="prod : ${productosAlerta}">
                                        <td th:text="${prod.nombre}">Nombre</td>
                                        <td class="font-weight-bold" th:text="${prod.cantidad}">0</td>
                                        <td>
                                            <span class="badge badge-danger" th:if="${prod.cantidad <= 3}">Urgente</span>
                                            <span class="badge badge-warning" th:if="${prod.cantidad > 3}">Bajo</span>
                                        </td>
                                        <td class="text-center">
                                            <a th:href="@{/compras/crear}" class="btn btn-xs btn-primary">
                                                <i class="fas fa-plus"></i> Surtir
                                            </a>
                                        </td>
                                    </tr>
                                    <tr th:if="${#lists.isEmpty(productosAlerta)}">
                                        <td colspan="4" class="text-center text-muted py-4">No hay alertas de stock pendientes</td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="card card-custom card-outline card-info shadow-sm">
                        <div class="card-header bg-white">
                            <h3 class="card-title font-weight-bold text-info">
                                <i class="fas fa-wallet mr-1"></i> Métodos de Pago
                            </h3>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="paymentMethodsChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <div class="modal fade" id="modalSuspension" data-backdrop="static" data-keyboard="false" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-danger shadow-lg">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title font-weight-bold" style="color: #f39c12;">
                        <i class="fas fa-exclamation-triangle mr-2"></i> SERVICIO SUSPENDIDO
                    </h5>
                </div>
                <div class="modal-body text-center py-4">
                    <div class="mb-3">
                        <i class="fas fa-user-slash text-danger" style="font-size: 4rem;"></i>
                    </div>
                    <h4 class="font-weight-bold">Acceso Restringido</h4>
                    <p class="text-muted">
                        La suscripción de <b th:text="${NombreEmpresa}">Empresa</b> ha expirado.
                        El sistema se encuentra bloqueado hasta que se regularice el pago.
                    </p>
                    <div class="alert alert-secondary border-orange" style="background-color: #1a222b; color: #f39c12;">
                        <i class="fab fa-whatsapp mr-2"></i> Contacte a Soporte: <b>+57 3028110131</b>
                    </div>
                </div>
                <div class="modal-footer bg-light d-flex justify-content-between">
                    <a th:href="@{/login?logout}" class="btn btn-secondary shadow-sm">
                        <i class="fas fa-sign-out-alt mr-1"></i> Salir
                    </a>
                    <button class="btn font-weight-bold px-4 shadow-sm" style="background-color: #f39c12; color: #1a222b;">
                        NOTIFICAR PAGO
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal Empresa Inactiva -->
    <div class="modal fade" id="modalInactivo" data-backdrop="static" data-keyboard="false" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-warning shadow-lg">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title font-weight-bold" style="color: #f39c12;">
                        <i class="fas fa-info-circle mr-2"></i> EMPRESA PENDIENTE DE ACTIVACIÓN
                    </h5>
                </div>
                <div class="modal-body text-center py-4">
                    <div class="mb-3">
                        <i class="fas fa-hourglass-half text-warning" style="font-size: 4rem;"></i>
                    </div>
                    <h4 class="font-weight-bold">Aún no estás activo</h4>
                    <p class="text-muted">
                        Hola <b th:text="${NombreEmpresa}">Empresa</b>, tu cuenta aún no ha sido activada por nuestro equipo administrativo.
                    </p>
                    <div class="alert alert-info">
                        <i class="fas fa-clock mr-2"></i> La activación se realizará en un máximo de <b>3 días hábiles</b>.
                    </div>
                    <p class="small text-muted">Agradecemos tu paciencia.</p>
                </div>
                <div class="modal-footer bg-light">
                    <a th:href="@{/logout}" class="btn btn-secondary shadow-sm btn-block">
                        <i class="fas fa-sign-out-alt mr-1"></i> Salir del Sistema
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
<th:block layout:fragment="scripts">
    <script th:src="@{/plugins/chart.js/Chart.min.js}"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <script th:inline="javascript">
        $(function () {
            // --- VARIABLES DESDE EL MODELO ---
            const EMPRESA_ID_LOGUEADA = /*[[${EmpresaId}]]*/ 0;
            const EMPRESA_ESTADO = /*[[${EmpresaEstado}]]*/ true;
            //const API_ADMIN_URL = 'https://ordexstep.store/admin/api/empresas';
            const API_ADMIN_URL = 'http://localhost:8082/api/empresas';
            // --- 0. VERIFICAR ESTADO ACTIVO ---
            function verificarEstadoActivo() {
                if (EMPRESA_ESTADO === false) {
                    $('#modalInactivo').modal('show');
                    document.body.style.overflow = 'hidden';
                    bloquearInteraccionGlobal();
                    return false;
                }
                return true;
            }

            // --- 1. LÓGICA DE SUSCRIPCIÓN ---
            async function verificarSuscripcion() {
                if(!EMPRESA_ID_LOGUEADA) return;

                try {
                    const { data } = await axios.get(`${API_ADMIN_URL}/${EMPRESA_ID_LOGUEADA}`);
                    const banner = document.getElementById('banner-vencimiento');
                    const mensaje = document.getElementById('mensaje-alerta');
                    const dias = data.diasRestantes;

                    if (dias <= 7) {
                        banner.classList.remove('hidden');
                        banner.classList.add('d-inline-flex');

                        if (dias >= 0) {
                            // Caso: Aviso de pocos días
                            mensaje.innerHTML = `<i class="fas fa-clock mr-2"></i> TU PLAN VENCE EN ${dias} DÍAS`;
                            banner.style.borderRightColor = "#f39c12";
                        } else {
                            // Caso: SUSPENDIDO
                            mensaje.innerHTML = `<i class="fas fa-ban mr-2"></i> SUSCRIPCIÓN VENCIDA`;
                            banner.style.borderRightColor = "#dc3545";
                            mensaje.style.color = "#dc3545";

                            // --- BLOQUEO CON MODAL ---
                            $('#modalSuspension').modal('show');

                            // Capa extra: Bloquear scroll y clics de fondo
                            document.body.style.overflow = 'hidden';
                            bloquearInteraccionGlobal();
                        }
                    }
                } catch (error) {
                    console.error("Error conectando al sistema de administración", error);
                }
            }

            function bloquearInteraccionGlobal() {
                const overlay = document.createElement('div');
                overlay.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; z-index:1040; background: rgba(0,0,0,0.1); cursor:not-allowed;';
                document.body.appendChild(overlay);
            }

            // --- 2. GRÁFICA DE PIE ---
            const metodosLabels = /*[[${metodosPagoLabels}]]*/ ['Sin Datos'];
            const metodosData = /*[[${metodosPagoValores}]]*/ [0];

            new Chart(document.getElementById('paymentMethodsChart').getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: metodosLabels,
                    datasets: [{
                        data: metodosData,
                        backgroundColor: ['#28a745', '#007bff', '#ffc107', '#dc3545', '#17a2b8', '#6610f2']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    legend: { position: 'bottom' },
                    cutoutPercentage: 65
                }
            });

            // Ejecutar verificación al cargar
            if (verificarEstadoActivo()) {
                verificarSuscripcion();
            }
        });
    </script>
</th:block>
</body>
</html>