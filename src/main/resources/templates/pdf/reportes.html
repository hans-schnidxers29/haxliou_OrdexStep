<!DOCTYPE html>
<html lang="es"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/adminlte}">
<head>
  <title>Centro de Reportes Maestro</title>
  <style>
    .reporte-card { transition: all 0.3s; cursor: pointer; border: 2px solid transparent; min-height: 160px; }
    .reporte-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.15) !important; border-color: #007bff; }
    .reporte-card.selected { border-color: #28a745; background-color: #f0fff4; }
    .reporte-icon { font-size: 2.5rem; margin-bottom: 0.8rem; }
    .stats-container { background: #f4f6f9; border-radius: 15px; padding: 20px; margin-bottom: 25px; border: 1px solid #dee2e6; }
    .card-stat { border: none; border-radius: 12px; color: white; }
    /* Colores por módulo */
    .bg-ventas { background: linear-gradient(135deg, #28a745, #1e7e34); }
    .bg-pedidos { background: linear-gradient(135deg, #007bff, #0056b3); }
    .bg-compras { background: linear-gradient(135deg, #17a2b8, #117a8b); }
    .bg-egresos { background: linear-gradient(135deg, #dc3545, #a71d2a); }
    .checkbox-xl {
      width: 1.5rem;
      height: 1.5rem;
      cursor: pointer;
    }
    .label-xl {
      font-size: 1.2rem;
      font-weight: bold;
      cursor: pointer;
      vertical-align: middle;
    }
    /* Estilo para tarjetas bloqueadas */
    .card-disabled {
      opacity: 0.5;
      pointer-events: none;
      filter: grayscale(80%);
      transition: all 0.3s ease;
    }
  </style>
</head>
<body>
<div layout:fragment="content">
  <section class="content-header">
    <div class="container-fluid">
      <h1><i class="fas fa-file-invoice-dollar mr-2 text-primary"></i> Consolidado de Reportes</h1>
    </div>
  </section>

  <section class="content">
    <div class="container-fluid">
      <div class="row mb-4">
        <div class="col-12">
          <div class="custom-control custom-checkbox bg-light p-3 border rounded shadow-sm">
            <input type="checkbox" class="checkbox-xl" id="checkTodo" onclick="gestionarBloqueo()">
            <label for="checkTodo" class="label-xl ml-2 mb-0">Descargar todos los documentos</label>
          </div>
        </div>
      </div>
      <h5 class="mb-3 mt-4 text-muted">Seleccione el módulo a exportar:</h5>
      <div class="row">
        <div class="col-md-3 mb-3">
          <div class="card reporte-card shadow text-center" onclick="seleccionarReporte('VENTAS', this)">
            <div class="card-body">
              <i class="fas fa-cash-register reporte-icon text-success"></i>
              <h6>Ventas Directas</h6>
            </div>
          </div>
        </div>
        <div class="col-md-3 mb-3">
          <div class="card reporte-card shadow text-center" onclick="seleccionarReporte('PEDIDOS', this)">
            <div class="card-body">
              <i class="fas fa-truck-loading reporte-icon text-primary"></i>
              <h6>Pedidos Especiales</h6>
            </div>
          </div>
        </div>
        <div class="col-md-3 mb-3">
          <div class="card reporte-card shadow text-center" onclick="seleccionarReporte('COMPRAS', this)">
            <div class="card-body">
              <i class="fas fa-shopping-basket reporte-icon text-info"></i>
              <h6>Compras a Prov.</h6>
            </div>
          </div>
        </div>
        <div class="col-md-3 mb-3">
          <div class="card reporte-card shadow text-center" onclick="seleccionarReporte('EGRESOS', this)">
            <div class="card-body">
              <i class="fas fa-file-invoice-dollar reporte-icon text-danger"></i>
              <h6>Gastos Varios</h6>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card reporte-card shadow text-center" onclick="seleccionarReporte('PRODUCTOS', this)">
            <div class="card-body">
              <i class="fas fa-boxes reporte-icon text-warning"></i>
              <h6>Inventario de Productos</h6>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card reporte-card shadow text-center" onclick="seleccionarReporte('CLIENTES', this)">
            <div class="card-body">
              <i class="fas fa-users reporte-icon text-secondary"></i>
              <h6>Base de Clientes</h6>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card reporte-card shadow text-center" onclick="seleccionarReporte('PROVEEDORES', this)">
            <div class="card-body">
              <i class="fas fa-truck reporte-icon text-dark"></i>
              <h6>Directorio de Proveedores</h6>
            </div>
          </div>
        </div>
      </div>

      <div class="row mt-4">
        <div class="col-md-12">
          <div class="card card-dark shadow">
            <div class="card-body d-flex justify-content-between align-items-center">
              <button type="button" onclick="generarReporte()" class="btn btn-success btn-lg px-5 shadow">
                <i class="fas fa-file-excel mr-2"></i> DESCARGAR EXCEL
              </button>
            </div>
          </div>
        </div>
      </div>

    </div>
  </section>

  <div id="data-storage" style="display: none;">

    <table id="tabla-VENTAS">
      <thead>
      <tr>
        <th>ID</th><th>Fecha</th><th>Cliente</th><th>Método Pago</th><th>Impuesto</th><th>Total</th>
      </tr>
      </thead>
      <tbody>
      <tr th:each="v : ${ventas}">
        <td th:text="${v.id}"></td>
        <td th:text="${#temporals.format(v.fechaVenta, 'dd/MM/yyyy HH:mm')}"></td>
        <td th:text="${v.cliente.nombre}"></td>
        <td th:text="${v.metodoPago}"></td>
        <td th:text="${v.impuesto} + '%'"></td>
        <td th:text="${v.total}"></td>
      </tr>
      </tbody>
    </table>

    <table id="tabla-PEDIDOS">
      <thead>
      <tr>
        <th>ID</th><th>Fecha Pedido</th><th>Cliente</th><th>Estado</th><th>Fecha Entrega</th><th>Total</th>
      </tr>
      </thead>
      <tbody>
      <tr th:each="p : ${pedidos}">
        <td th:text="${p.id}"></td>
        <td th:text="${#temporals.format(p.fechaPedido, 'dd/MM/yyyy')}"></td>
        <td th:text="${p.cliente.nombre}"></td>
        <td th:text="${p.estado}"></td>
        <td th:text="${#temporals.format(p.fechaEntrega, 'dd/MM/yyyy')}"></td>
        <td th:text="${p.total}"></td>
      </tr>
      </tbody>
    </table>

    <table id="tabla-CLIENTES">
      <thead>
      <tr>
        <th>ID</th><th>Documento</th><th>Nombre Completo</th><th>Email</th><th>Teléfono</th><th>Dirección</th>
      </tr>
      </thead>
      <tbody>
      <tr th:each="c : ${clientes}">
        <td th:text="${c.id}"></td>
        <td th:text="${c.tipoidentificacion} + ': ' + ${c.numeroIdentificacion}"></td>
        <td th:text="${c.nombre} + ' ' + ${c.apellido}"></td>
        <td th:text="${c.email}"></td>
        <td th:text="${c.telefono}"></td>
        <td th:text="${c.direccion} + ' (' + ${c.ciudad} + ')'"></td>
      </tr>
      </tbody>
    </table>

    <table id="tabla-PRODUCTOS">
      <thead>
      <tr>
        <th>ID</th><th>Nombre</th><th>Categoría</th><th>Stock Actual</th><th>Unidad</th><th>Precio Venta</th><th>Proveedor</th><th>Tipo de Impuesto</th>
      </tr>
      </thead>
      <tbody>
      <tr th:each="prod : ${productos}">
        <td th:text="${prod.id}"></td>
        <td th:text="${prod.nombre}"></td>
        <td th:text="${prod.categoria.nombrecategoria}"></td>
        <td th:text="${prod.cantidad}"></td>
        <td th:text="${prod.tipoVenta.name}"></td>
        <td th:text="${prod.precio}"></td>
        <td th:text="${prod.proveedor}"></td>
        <td th:text="${prod.tipo_Impuesto}"></td>
      </tr>
      </tbody>
    </table>

    <table id="tabla-PROVEEDORES">
      <thead>
      <tr>
        <th>ID</th><th>Nombre/Razón Social</th><th>NIT/Documento</th><th>Email</th><th>Teléfono</th><th>Estado</th>
      </tr>
      </thead>
      <tbody>
      <tr th:each="prov : ${proveedores}">
        <td th:text="${prov.id}"></td>
        <td th:text="${prov.nombre}"></td>
        <td th:text="${prov.numeroDocumento}"></td>
        <td th:text="${prov.email}"></td>
        <td th:text="${prov.telefono}"></td>
        <td th:text="${prov.estado ? 'Activo' : 'Inactivo'}"></td>
      </tr>
      </tbody>
    </table>

    <table id="tabla-COMPRAS">
      <thead>
      <tr>
        <th>ID</th><th>Referencia</th><th>Proveedor</th><th>Fecha Compra</th><th>Estado</th><th>Total Pago</th>
      </tr>
      </thead>
      <tbody>
      <tr th:each="comp : ${compras}">
        <td th:text="${comp.id}"></td>
        <td th:text="${comp.numeroReferencia}"></td>
        <td th:text="${comp.proveedor.nombre}"></td>
        <td th:text="${#temporals.format(comp.fechaCompra, 'dd/MM/yyyy')}"></td>
        <td th:text="${comp.estado}"></td>
        <td th:text="${comp.total}"></td>
      </tr>
      </tbody>
    </table>

    <table id="tabla-EGRESOS">
      <thead>
      <tr>
        <th>ID</th><th>Fecha</th><th>Categoría Gasto</th><th>Descripción</th><th>Monto</th>
      </tr>
      </thead>
      <tbody>
      <tr th:each="e : ${egresos}">
        <td th:text="${e.id}"></td>
        <td th:text="${#temporals.format(e.fechaRegistro, 'dd/MM/yyyy HH:mm')}"></td>
        <td th:text="${e.tipoEgreso.decripcion}"></td>
        <td th:text="${e.descripcion}"></td>
        <td th:text="${e.monto}"></td>
      </tr>
      </tbody>
    </table>
  </div>
</div>

<th:block layout:fragment="scripts">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script th:inline="javascript">
    let reporteSeleccionado = null;

    function seleccionarReporte(tipo, elemento) {
      document.querySelectorAll('.reporte-card').forEach(c => c.classList.remove('selected'));
      elemento.classList.add('selected');
      reporteSeleccionado = tipo;
      document.getElementById('checkTodo').checked = false;
    }

    function generarReporte() {
      const exportarTodo = document.getElementById('checkTodo').checked;
      let tipo = exportarTodo ? 'CONSOLIDADO' : reporteSeleccionado;

      if (!tipo) {
        Swal.fire('Error', 'Por favor seleccione un módulo o marque Exportar Todo', 'error');
        return;
      }

      Swal.fire({ title: 'Procesando Excel', timerProgressBar: true, didOpen: () => { Swal.showLoading(); } });

      setTimeout(() => {
        ejecutarExportacion(tipo);
        Swal.close();
      }, 800);
    }

    function ejecutarExportacion(tipo) {
      const wb = XLSX.utils.book_new();
      const fecha = new Date().toLocaleDateString().replace(/\//g, '-');

      if (tipo === 'CONSOLIDADO') {
        const modulos = ['VENTAS', 'PEDIDOS', 'COMPRAS', 'EGRESOS', 'PRODUCTOS', 'CLIENTES', 'PROVEEDORES'];
        modulos.forEach(m => {
          const tabla = document.getElementById('tabla-' + m);
          if (tabla) {
            const ws = XLSX.utils.table_to_sheet(tabla);
            XLSX.utils.book_append_sheet(wb, ws, m);
          }
        });
      } else {
        const tabla = document.getElementById('tabla-' + tipo);
        if (tabla) {
          const ws = XLSX.utils.table_to_sheet(tabla);
          XLSX.utils.book_append_sheet(wb, ws, tipo);
        }
      }

      XLSX.writeFile(wb, `Reporte_Sistema_${tipo}_${fecha}.xlsx`);
    }
    function gestionarBloqueo() {
      const isChecked = document.getElementById('checkTodo').checked;
      const contenedor = document.getElementById('contenedorCards');

      if (isChecked) {
        // Añade la clase que opaca y bloquea los clics
        contenedor.classList.add('card-disabled');

        // Opcional: Mostrar un aviso rápido con showToast si ya la tienes definida
        if (typeof showToast === "function") {
          showToast('info', 'Tarjetas bloqueadas: Descarga completa activada');
        }
      } else {
        // Remueve el bloqueo
        contenedor.classList.remove('card-disabled');
      }
    }
  </script>
</th:block>
</body>
</html>